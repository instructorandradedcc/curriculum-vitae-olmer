<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Panel de Administración AR (Geolocalización)</title>
    <link rel="icon" href="https://raw.githubusercontent.com/instructorandradedcc/propuesta-AR/main/favicon3dAR.ico">
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- (MEJORA) Bibliotecas A-Frame y AR.js actualizadas a versiones estables -->
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/v3.4.5/aframe/build/aframe-ar-nft.js"></script> <!-- Esta versión incluye location-based (GPS) -->

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <style>
        html, body {
            margin: 0; padding: 0; width: 100%; height: 100%;
            overflow: hidden; font-family: 'Inter', sans-serif;
        }
        .page {
            display: none; height: 100%; width: 100%;
            position: relative; overflow-y: auto; /* Allow scrolling on pages */
             padding-bottom: 60px; /* Add padding for controls */
        }
        .page.active { display: block; }
        .page#map-page { overflow: hidden; } /* Map page should not scroll */

        /* Login Page specific styles */
        .page#login-page {
            display: none; /* Forced hidden when not active */
            align-items: center;
            justify-content: center;
            background-color: #f3f4f6; /* bg-gray-200 */
        }
        .page#login-page.active {
            display: flex; /* Forced visible/flex when active */
        }

        /* Loader animation */
        .loader {
            border: 4px solid #f3f3f3; border-top: 4px solid #3498db;
            border-radius: 50%; width: 40px; height: 40px;
            animation: spin 1s linear infinite; margin-bottom: 20px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* General button styles */
        .control-button {
            background-color: #4CAF50; color: white; padding: 10px 20px;
            border: none; border-radius: 8px; font-size: 16px;
            cursor: pointer; transition: background-color 0.3s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .control-button:hover:not(:disabled) { background-color: #45a049; }
        .control-button:disabled { background-color: #a0a0a0; cursor: not-allowed; opacity: 0.7; }

        /* Specific button styles */
        .delete-btn-map { /* Map delete button */
             background-color: #f44336; /* Red */
             color: white;
             font-size: 0.75rem; /* text-xs */
             padding: 0.25rem 0.5rem; /* px-2 py-1 */
             border-radius: 0.25rem; /* rounded */
             margin-left: 0.25rem; /* ml-1 */
             transition: background-color 0.3s;
        }
        .delete-btn-map:hover:not(:disabled) {
             background-color: #d32f2f;
        }
         .delete-btn-map.confirm { /* Confirm state */
             background-color: #ff9800; /* Orange */
         }
         .delete-btn-map.confirm:hover:not(:disabled) {
             background-color: #f57c00;
         }

         /* Secondary action button (e.g., Back buttons) */
         .secondary-action-btn {
             background-color: #607d8b; /* Blue Grey */
             color: white;
             padding: 8px 16px; /* Slightly smaller */
             border: none;
             border-radius: 6px;
             font-size: 14px;
             cursor: pointer;
             transition: background-color 0.3s;
             box-shadow: 0 2px 4px rgba(0,0,0,0.1);
             margin-top: 8px; /* Add some space */
         }
         .secondary-action-btn:hover:not(:disabled) {
             background-color: #546e7a;
         }

        /* Message box for notifications */
        #message-box {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.7); color: white;
            padding: 10px 20px; border-radius: 8px; font-size: 1rem;
            z-index: 10001; opacity: 0; transition: opacity 0.5s ease-in-out;
            pointer-events: none; max-width: 90%; text-align: center;
        }
        #message-box.show { opacity: 1; }

        /* Map and AR styles */
        #map-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        #map-canvas { width: 100%; height: 100%; z-index: 1; cursor: grab; }
        #map-controls { position: fixed; top: 20px; right: 20px; z-index: 402; display: flex; flex-direction: column; gap: 10px; }

        /* Crosshair in the center of the map */
        #map-crosshair {
            position: absolute !important;
            top: 50% !important;
            left: 50% !important;
            transform: translate(-50%, -50%) !important;
            width: 30px !important;
            height: 30px !important;
            border: 2px solid white !important;
            border-radius: 50% !important;
            box-shadow: 0 0 10px black, 0 0 0 2px rgba(0, 0, 0, 0.5) !important;
            pointer-events: none !important;
            z-index: 1000 !important;
        }

        /* Jump to coordinates input */
        #coords-jumpto {
            position: fixed; top: 20px; left: 20px; z-index: 402;
            background-color: rgba(255, 255, 255, 0.9);
            padding: 10px; border-radius: 8px; display: flex; gap: 5px; align-items: center;
        }
        /* Display for map center coordinates */
        #map-center-coords {
             position: fixed;
             top: 75px; /* Adjusted position */
             left: 20px;
             z-index: 402;
             background-color: rgba(0, 0, 0, 0.75);
             color: white;
             padding: 8px 12px;
             border-radius: 8px;
             font-size: 0.8rem;
             font-family: monospace;
             box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        #map-center-coords span { display: block; }

        /* Map UI Panels (Placement, Placed POIs, Edit) */
        .map-panel {
             position: fixed;
             top: 80px;
             left: 10px;
             z-index: 401;
             background-color: rgba(255, 255, 255, 0.95);
             padding: 15px;
             border-radius: 8px;
             box-shadow: 0 2px 10px rgba(0,0,0,0.2);
             max-width: 300px;
             width: 90%; /* Responsive width */
             max-height: calc(100vh - 180px); /* Limit height */
             overflow-y: auto; /* Allow scrolling within panel */
             backdrop-filter: blur(5px);
        }
        #edit-location-panel {
             border: 2px solid #f59e0b; /* Amber border for editing */
        }
         /* Placed POIs panel on the right */
        #placed-pois-panel {
             left: auto;
             right: 10px;
             max-width: 250px; /* Smaller width for side panel */
             transition: transform 0.3s ease-out; /* Slide animation */
        }
        /* Style for minimized POIs panel */
        #placed-pois-panel.minimized {
             transform: translateX(calc(100% - 40px)); /* Slide out, leave toggle visible */
             overflow-y: hidden;
             box-shadow: none;
             padding: 5px;
        }
        #placed-pois-panel.minimized h3,
        #placed-pois-panel.minimized .text-xs,
        #placed-pois-panel.minimized #placed-pois-list {
             display: none; /* Hide content when minimized */
        }
        /* Toggle button for POIs panel (moved to map-controls) */
        #toggle-pois-btn {
             background-color: #607d8b; /* Blue Grey */
             /* Inherits control-button styles */
        }

        /* Image preview in placement panel */
        #placement-preview-image {
             max-width: 100px;
             max-height: 100px;
             margin: 10px auto;
             border: 1px solid #ccc;
             border-radius: 4px;
             display: none; /* Hidden by default */
             object-fit: contain; /* Ensure image fits */
         }
        /* Image preview in map popups */
        .leaflet-popup-content img.popup-image {
             max-width: 100px;
             max-height: 100px;
             display: block;
             margin: 5px auto;
             border-radius: 4px;
         }

        /* A-Frame scene positioning */
        a-scene { position: fixed !important; top: 0 !important; left: 0 !important; width: 100% !important; height: 100% !important; z-index: 1 !important; }
        /* AR.js loading indicator */
        .arjs-loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); color: white; display: none; flex-direction: column; justify-content: center; align-items: center; font-size: 1.5rem; z-index: 10000; text-align: center; }
        /* Permission request modal */
        .permission-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.8); display: none; justify-content: center; align-items: center; z-index: 10001; }
        .permission-content { background-color: white; padding: 20px; border-radius: 10px; max-width: 80%; text-align: center; }
        .permission-button { background-color: #4CAF50; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-top: 15px; }

        /* AR view controls (SOLUCIÓN UI 1/2) */
        #ar-controls {
            position: fixed;
            top: 20px; /* Movido a la parte superior */
            right: 20px; /* Movido a la derecha */
            left: auto; /* Limpiado 'left' */
            transform: none; /* Limpiado 'transform' */
            z-index: 10000; /* Aumentado z-index para estar sobre el panel GPS */
            display: flex;
            flex-direction: column; /* Apilado vertical */
            gap: 10px;
            align-items: flex-end; /* Alineado a la derecha */
        }
        /* AR info panel (GPS status) */
        .ar-info-panel { position: fixed; top: 20px; left: 20px; background-color: rgba(0,0,0,0.7); color: white; padding: 10px; border-radius: 8px; font-size: 14px; z-index: 9998; }

        /* AR Loading Screen */
        .ar-loading-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #1a2a6c, #2a5298); color: white;
            display: none; flex-direction: column; justify-content: center; align-items: center;
            z-index: 10002;
        }
        .ar-loading-screen.active { display: flex; }
        /* Progress Bar */
        #progress-bar-container {
            width: 80%; max-width: 400px; background: rgba(255, 255, 255, 0.2);
            border-radius: 5px; margin-top: 20px; height: 10px;
            overflow: hidden;
        }
        #progress-bar {
            width: 0%; height: 100%; background: #4CAF50;
            border-radius: 5px; transition: width 0.3s ease;
        }
        #loading-asset-status {
             margin-top: 10px;
             font-size: 0.9rem;
             color: #ccc;
             min-height: 20px; /* Prevent layout shift */
             text-align: center;
         }

        /* AR Guidance Panel */
        #ar-guide {
             position: fixed;
             top: 100px;
             left: 50%;
             transform: translateX(-50%);
             background-color: rgba(0, 0, 0, 0.7);
             color: white;
             padding: 10px 15px;
             border-radius: 8px;
             font-size: 1.1rem;
             font-weight: bold;
             z-index: 9999;
             text-align: center;
             display: none; /* Hidden by default */
             border: 2px solid #FFC107; /* Amber border */
         }

        /* (NUEVO) Panel de Ubicación en Tiempo Real */
        #ar-realtime-location {
             position: fixed;
             top: 170px; /* Debajo del panel ar-guide */
             left: 50%;
             transform: translateX(-50%);
             background-color: rgba(0, 0, 0, 0.7);
             color: white;
             padding: 10px 15px;
             border-radius: 8px;
             font-size: 0.9rem; /* Un poco más pequeño */
             font-family: monospace; /* Bueno para coords */
             z-index: 9999;
             text-align: center;
             display: none; /* Oculto por defecto, se muestra en startARFlow */
             border: 2px solid #f44336; /* Borde rojo como pidió el usuario */
             min-width: 250px;
         }
        #ar-realtime-location div {
             font-family: 'Inter', sans-serif; /* Fuente normal para el título */
             font-weight: bold;
             font-size: 1.0rem;
             margin-bottom: 5px;
         }


        /* AR Scale Controls Panel (SOLUCIÓN UI 2/2) */
        #ar-scale-controls {
            position: fixed;
            bottom: 20px; /* Movido a la parte inferior */
            left: 50%;
            transform: translateX(-50%);
            z-index: 9999; /* z-index igual al de los botones (ahora separados) */
            width: 80%;
            max-width: 400px;
            background-color: rgba(0, 0, 0, 0.7);
            padding: 10px;
            border-radius: 8px;
            color: white;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .scale-label-ar {
             font-size: 0.8rem;
             font-weight: normal;
         }
        .scale-value-ar {
             font-weight: bold;
             color: #4CAF50; /* Green */
         }

        /* Styles for AR video elements */
        a-video { border: 2px solid white; background-color: black; }

        /* Critical CSS Overrides for Camera Feed */
        video, .arjs-video {
            position: fixed !important; top: 0 !important; left: 0 !important;
            width: 100% !important; height: 100% !important; object-fit: cover !important;
            z-index: -1 !important; /* Behind AR content */
            display: block !important; opacity: 1 !important;
            visibility: visible !important;
            /* Ensure playback on mobile */
            autoplay: true !important;
            playsinline: true !important;
            webkit-playsinline: true !important;
            muted: true !important; /* Must be muted initially */
        }
        /* Ensure A-Frame canvas is transparent */
        canvas, .a-canvas {
            background: transparent !important; background-color: rgba(0, 0, 0, 0) !important;
            z-index: 1 !important; /* Above video feed */
            position: fixed !important; top: 0 !important;
            left: 0 !important; width: 100% !important; height: 100% !important;
        }

        /* (NUEVO) Canvas temporal para captura de pantalla */
        #screenshot-canvas {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-900">

    <div id="login-page" class="page active flex items-center justify-center bg-gray-200">
        <div class="bg-white p-10 rounded-lg shadow-xl text-center max-w-sm w-full">
            <h1 class="text-3xl font-bold text-blue-700 mb-6">Admin AR</h1>
            <p class="text-gray-600 mb-8">Por favor, inicia sesión para continuar.</p>
            <button id="google-login-btn" class="control-button bg-blue-500 hover:bg-blue-600 w-full flex items-center justify-center gap-2">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M21.35 12.24c0-.79-.07-1.54-.2-2.28h-9.15v4.3h5.16c-.22 1.4-.87 2.6-1.95 3.4v2.8h3.59c2.1-1.9 3.3-4.5 3.3-7.22z"/><path d="M12 21.8c2.6 0 4.7-.87 6.2-2.3l-3.6-2.8c-.87.6-1.9.9-3.1.9-2.4 0-4.5-1.6-5.2-3.8H3.1v2.9c1.5 3 4.5 5 8.2 5z"/><path d="M6.8 14.3c-.2-.6-.3-1.2-.3-1.8s.1-1.2.3-1.8V7.8H3.1c-.6 1.2-1 2.5-1 4s.4 2.8 1 4l3.7-2.9z"/><path d="M12 6.3c1.4 0 2.6.5 3.6 1.4l3.2-3.2C17.2 2.8 14.8 2 12 2c-3.7 0-6.7 2-8.2 5l3.7 2.9c.7-2.2 2.8-3.8 5.2-3.8z"/></svg>
                <span>Iniciar Sesión con Google</span>
            </button>
        </div>
    </div>

    <div id="admin-page" class="page">
        <div class="container mx-auto p-6 max-w-4xl">
            <div class="flex flex-wrap justify-between items-center mb-8 gap-4">
                <div>
                    <h1 class="text-3xl font-bold text-blue-700">Panel de Administración AR</h1>
                    <div class="text-sm text-gray-500 mt-1">
                        <span id="version-display" class="font-normal align-middle"></span>
                        <span id="user-info" class="hidden ml-4">
                            Logueado como: <strong id="user-email"></strong>
                        </span>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button id="logout-btn" class="control-button bg-red-500 hover:bg-red-600 hidden">Salir</button>
                    <button id="goto-map-btn" class="control-button bg-indigo-500 hover:bg-indigo-600" disabled>Ir al Mapa</button>
                </div>
            </div>

            <div class="bg-white p-6 rounded-lg shadow-md mb-8">
                <h2 class="text-2xl font-semibold mb-4">1. Seleccionar Contenido para Colocar</h2>
                <p class="text-gray-600 mb-4">Marca los modelos o define el video que quieres posicionar en el mapa.</p>
                <div id="ecopiensa-selection-list" class="grid grid-cols-2 md:grid-cols-3 gap-4">
                     <p id="loading-models-placeholder" class="text-gray-500 col-span-full">Cargando modelos...</p>
                </div>
                <div class="mt-4 pt-4 border-t">
                     <label class="flex items-center space-x-2 p-2 border rounded-md hover:bg-gray-50 cursor-pointer">
                           <input type="checkbox" id="select-video-cb" class="h-5 w-5 text-blue-600">
                           <span>Añadir un Video Personalizado</span>
                     </label>
                </div>
                <h2 class="text-2xl font-semibold mt-6 mb-4">2. Ir al Mapa para Posicionar</h2>
                <p class="text-gray-600">El contenido que selecciones aquí estará disponible en el panel del mapa.</p>
                 <button id="clear-selection-btn" class="mt-4 text-sm text-red-600 hover:text-red-800 underline">Limpiar selección guardada</button>
            </div>

            <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-2xl font-semibold mb-4">Contenido Geoposicionado Guardado</h2>
                <div id="poi-list-container" class="space-y-4">
                    <p id="loading-pois" class="text-gray-500 font-semibold">Inicializando Firebase...</p>
                 </div>
            </div>
        </div>
    </div>

    <div id="map-page" class="page">
        <div id="map-container">
            <div id="map-canvas"></div>
            <div id="map-crosshair"></div>
         </div>

        <div id="coords-jumpto">
            <input type="number" id="jumpto-lat" placeholder="Latitud" class="w-24 p-1 border rounded text-sm">
            <input type="number" id="jumpto-lon" placeholder="Longitud" class="w-24 p-1 border rounded text-sm">
            <button id="jumpto-btn" class="control-button bg-blue-500 hover:bg-blue-600 p-2 text-sm">Ir</button>
        </div>
        <div id="map-center-coords">
             <span>Lat: --</span>
             <span>Lon: --</span>
         </div>

        <div id="placement-panel" class="map-panel">
            <h3 class="text-lg font-semibold mb-2">Colocar Nuevo Contenido</h3>
            <div id="models-to-place-list" class="space-y-2 mb-4">
                <p class="text-sm text-gray-500">No hay contenido nuevo seleccionado. Vuelve al Panel.</p>
            </div>

            <div class="slider-container mb-4">
                <label for="map-zoom-slider" class="block text-sm font-medium text-gray-700">Zoom del Mapa</label>
                <input id="map-zoom-slider" type="range" min="1" max="22" value="15" step="1" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
            </div>

            <div id="placement-form-container" class="hidden space-y-3">
                <h4 id="placing-model-name" class="font-semibold text-blue-600 text-center text-lg mb-2"></h4>
                <img id="placement-preview-image" src="" alt="Vista previa">

                 <div>
                     <label class="block text-sm font-medium text-gray-700">Tipo de POI</label>
                     <select id="place-poi-type" class="mt-1 w-full p-2 border border-gray-300 rounded">
                           <option value="model" selected>Modelo 3D</option>
                           <option value="video">Video (.mp4)</option>
                     </select>
                 </div>

                 <div id="model-fields">
                     <div>
                           <label for="place-model-url" class="block text-sm font-medium text-gray-700">URL Modelo (.glb)</label>
                           <input type="url" id="place-model-url" class="mt-1 w-full p-2 border border-gray-300 rounded bg-gray-100" readonly>
                     </div>
                 </div>
                 <div id="video-fields" class="hidden">
                      <div>
                           <label for="place-video-url" class="block text-sm font-medium text-gray-700">URL Video (.mp4)</label>
                           <input type="url" id="place-video-url" class="mt-1 w-full p-2 border border-gray-300 rounded" placeholder="https://.../video.mp4">
                      </div>
                 </div>

                 <div>
                   <label for="place-name" class="block text-sm font-medium text-gray-700">Nombre Descriptivo</label>
                   <input type="text" id="place-name" class="mt-1 w-full p-2 border border-gray-300 rounded">
                 </div>
                 <div>
                   <label for="place-scale" class="block text-sm font-medium text-gray-700">Escala Base (Video: ancho m)</label>
                   <input type="number" id="place-scale" class="mt-1 w-full p-2 border border-gray-300 rounded" step="0.1" value="1.0" min="0.1">
                 </div>
                 <div>
                   <label for="place-ground-height" class="block text-sm font-medium text-gray-700">Altura sobre terreno (m)</label>
                   <input type="number" id="place-ground-height" class="mt-1 w-full p-2 border border-gray-300 rounded" step="0.1" value="0.0">
                 </div>
                 <div>
                   <label for="place-sound-url" class="block text-sm font-medium text-gray-700">URL Sonido Fondo (Opcional, .mp3)</label>
                   <input type="url" id="place-sound-url" class="mt-1 w-full p-2 border border-gray-300 rounded" placeholder="https://.../musica.mp3">
                 </div>
                 <div>
                   <label for="place-start-date" class="block text-sm font-medium text-gray-700">Fecha Inicio</label>
                   <input type="date" id="place-start-date" class="mt-1 w-full p-2 border border-gray-300 rounded">
                 </div>
                 <div>
                   <label for="place-end-date" class="block text-sm font-medium text-gray-700">Fecha Fin</label>
                   <input type="date" id="place-end-date" class="mt-1 w-full p-2 border border-gray-300 rounded">
                 </div>

                <p class="text-sm text-blue-600 font-semibold pt-2">Mueve el mapa para centrar la cruz en la ubicación deseada.</p>
                <button id="save-placement-btn" class="w-full control-button bg-green-500 hover:bg-green-600 font-bold">
                    Guardar Ubicación (en la Cruz)
                </button>
                <button id="back-to-selection-btn" class="w-full secondary-action-btn hover:bg-gray-600">Volver a Seleccionar</button>
                <button id="cancel-placement-btn" class="w-full secondary-action-btn bg-gray-500 hover:bg-gray-600 mt-2">Cancelar Colocación Total</button>
             </div>
        </div>

         <div id="placed-pois-panel" class="map-panel right-3">
             <h3 class="text-lg font-semibold mb-2">Contenido en el Mapa</h3>
             <p class="text-xs text-amber-700 mb-2">Datos guardados en Firebase.</p>
            <div id="placed-pois-list" class="space-y-3">
                 <p class="text-sm text-gray-500">Cargando contenido guardado...</p>
                 </div>
         </div>

         <div id="edit-location-panel" class="map-panel hidden">
             <h3 class="text-lg font-semibold mb-2">Editando Ubicación</h3>
             <p id="editing-poi-name" class="text-sm font-medium text-gray-700 mb-2"></p>
             <p class="text-sm text-amber-700 font-semibold mb-3">Mueve el mapa para centrar la cruz en la NUEVA ubicación.</p>
             <button id="save-edit-location-btn" class="w-full control-button bg-amber-500 hover:bg-amber-600 font-bold mb-2">
                 Guardar Nueva Ubicación (en la Cruz)
             </button>
             <button id="cancel-edit-location-btn" class="w-full secondary-action-btn bg-gray-500 hover:bg-gray-600">
                 Cancelar Edición
             </button>
         </div>

        <div id="map-controls">
            <button id="toggle-pois-btn" class="control-button bg-gray-700 hover:bg-gray-800">Ocultar POIs</button>
            <button id="back-to-admin-btn" class="control-button bg-gray-500 hover:bg-gray-600">Volver al Panel</button>
            <button id="goto-summary-btn" class="control-button bg-purple-500 hover:bg-purple-600">Ver Resumen</button>
         </div>
    </div>

    <div id="summary-page" class="page">
         <div class="container mx-auto p-6 max-w-4xl">
             <div class="flex flex-wrap justify-between items-center mb-8 gap-4">
                   <h1 class="text-3xl font-bold text-purple-700">Resumen de Configuración AR</h1>
                   <div class="flex gap-2">
                       <button id="back-to-map-btn" class="control-button bg-gray-500 hover:bg-gray-600">Volver al Mapa</button>
                       <button id="launch-ar-btn" class="control-button bg-green-500 hover:bg-green-600">¡Probar AR!</button>
                   </div>
             </div>
             <div class="bg-white p-6 rounded-lg shadow-md">
                   <h2 class="text-2xl font-semibold mb-4">Contenido Configurado</h2>
                   <p class="text-gray-600 mb-4">Este es el contenido que se mostrará en la Realidad Aumentada (si está dentro de las fechas activas).</p>
                   <div id="summary-poi-list" class="space-y-4">
                         <p id="loading-summary-pois" class="text-gray-500">Cargando resumen...</p>
                   </div>
             </div>
         </div>
    </div>

    <div id="ar-page" class="page">
        <div id="ar-loading-screen" class="ar-loading-screen active">
            <div class="loading-content flex flex-col items-center">
                <div class="loader"></div>
                <div id="loading-status-text" class="text-xl">Preparando componentes...</div>
                <div id="progress-bar-container">
                    <div id="progress-bar"></div>
                </div>
                <div id="loading-asset-status" class="text-center"></div>
            </div>
        </div>

        <div id="ar-scene-container"></div>

        <div id="ar-guide" style="display:none;">
            Modelo más cercano: <span id="guide-name"></span><br>
            Distancia: <span id="guide-distance">--m</span> - Dirección: <span id="guide-bearing">--</span>
        </div>

        <div id="ar-realtime-location" style="display:none;">
             <div>Tu Ubicación (GPS):</div>
             <span id="realtime-lat">Lat: --.--</span><br>
             <span id="realtime-lon">Lon: --.--</span>
        </div>

        <div id="ar-scale-controls">
             <label for="ar-scale-slider" class="scale-label-ar">Ajuste Fino de Escala: <span id="ar-scale-value-display" class="scale-value-ar">1.0x</span></label>
             <input id="ar-scale-slider" type="range" min="0.1" max="5.0" value="1.0" step="0.05" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
        </div>

        <div class="ar-info-panel">
            <div><strong>GPS:</strong> <span id="gps-status">Buscando...</span></div>
            <div><strong>Precisión:</strong> <span id="gps-accuracy" style="font-weight: bold;">--</span>m</div>
        </div>
        <div id="ar-controls">
            <button id="back-to-summary-btn" class="control-button bg-gray-500 hover:bg-gray-600">Volver al Resumen</button>
            <button id="save-ar-scale-btn" class="control-button bg-orange-500 hover:bg-orange-600" disabled>Guardar Escala (para POI más cercano)</button>
            <!-- (NUEVO) Botón de Captura de Pantalla -->
            <button id="screenshot-btn" class="control-button bg-blue-500 hover:bg-blue-600">Capturar Foto</button>
        </div>
    </div>

    <div id="permission-modal" class="permission-modal">
        <div class="permission-content">
            <h2>Permisos necesarios</h2>
            <p>Esta aplicación necesita acceso a tu cámara y ubicación (Alta Precisión) para la experiencia de Realidad Aumentada.</p>
            <button id="grant-permissions-btn" class="permission-button">Conceder Permisos</button>
        </div>
    </div>

    <div id="message-box"></div>

    <!-- (NUEVO) Canvas temporal para combinar la captura de pantalla -->
    <canvas id="screenshot-canvas"></canvas>

    <script type="module">
        // Import necessary Firebase functions
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import {
            getAuth,
            onAuthStateChanged,
            GoogleAuthProvider,
            signInWithPopup,
            signOut
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import {
            getFirestore,
            collection,
            addDoc,
            doc,
            deleteDoc,
            updateDoc,
            onSnapshot,
            query,
            setLogLevel
         } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- App Version ---
        // Increment this with EVERY change.
        const APP_VERSION = '1.52'; // (FIX) Corregido parseo de evento GPS y añadido botón de captura.
        const LOCALSTORAGE_KEY = 'arAdminModelSelection'; // Key for local storage

        // --- Ecopiensa Models Data ---
        const GITHUB_BASE_URL_MODELS = 'https://raw.githubusercontent.com/instructorandradedcc/7777ar/main/asetss/modelss/';
        const GITHUB_BASE_URL_IMAGES = 'https://raw.githubusercontent.com/instructorandradedcc/7777ar/main/asetss/imagenes/';
        const ECOPIENSA_MODELS = [
            { name: 'Botellita Azul', modelUrl: `${GITHUB_BASE_URL_MODELS}botellytaazul.glb`, imageUrl: `${GITHUB_BASE_URL_IMAGES}botellytaazul.jpg` },
            { name: 'Ecoladrillo', modelUrl: `${GITHUB_BASE_URL_MODELS}ecoladrillo.glb`, imageUrl: `${GITHUB_BASE_URL_IMAGES}ecoladrillo.jpg` },
            { name: 'Lata Plateada', modelUrl: `${GITHUB_BASE_URL_MODELS}lataplateada.glb`, imageUrl: `${GITHUB_BASE_URL_IMAGES}lataplateada.jpg` },
            { name: 'Papelito Verde', modelUrl: `${GITHUB_BASE_URL_MODELS}papelitoverde.glb`, imageUrl: `${GITHUB_BASE_URL_IMAGES}papelitoverde.jpg` },
            { name: 'Señor Contenedor', modelUrl: `${GITHUB_BASE_URL_MODELS}senorcontenedor.glb`, imageUrl: `${GITHUB_BASE_URL_IMAGES}senorcontenedor.jpg` },
            { name: 'Tapa Roja', modelUrl: `${GITHUB_BASE_URL_MODELS}taparoja.glb`, imageUrl: `${GITHUB_BASE_URL_IMAGES}taparoja.jpg` }
        ];
        // Placeholder for custom video selection
        const CUSTOM_VIDEO_PLACEHOLDER = { name: "Video Personalizado", url: "CUSTOM_VIDEO", isCustomVideo: true, imageUrl: "https://placehold.co/100x100/764ba2/white?text=Video" };

        
       // --- INICIO: Bloque de configuración de Firebase ---

        // Tal como solicitaste, las claves hardcoded han sido eliminadas.
        // Pega tu configuración de Firebase aquí.
        
        let firebaseConfig;
        let appId; // Este será el 'projectId' o '__app_id'

        try {
             // Intenta usar la configuración de Canvas si existe
            if (typeof __firebase_config !== 'undefined' && __firebase_config &&
                typeof __app_id !== 'undefined' && __app_id) {
                
                firebaseConfig = JSON.parse(__firebase_config);
                appId = __app_id; // Usa el __app_id de Canvas
                console.log("Usando configuración de Firebase y App ID de Canvas.");
            } else {
                 // Si no, usa la configuración manual que debes pegar abajo
                console.warn("Variables de Canvas no definidas. Usando la configuración manual.");
                
                // !! IMPORTANTE !!
                // !! Pega tu objeto de configuración de Firebase aquí (reemplaza esto): !!
                
                // CORRECCIÓN: Asignamos a la variable 'firebaseConfig' de arriba,
                // no declaramos una nueva con 'const'.
                firebaseConfig = {
                  apiKey: "AIzaSyBkxP7vqrVZMRhl-vUpHMMKjj5aIujDQ3k",
                  authDomain: "centro-comercial-1ea64.firebaseapp.com",
                  projectId: "centro-comercial-1ea64",
                  storageBucket: "centro-comercial-1ea64.firebasestorage.app",
                  messagingSenderId: "667808330264",
                  appId: "1:667808330264:web:9718955b58aba4359b096d",
                  measurementId: "G-3ZPG0Q8FL6"
                };
                
                // Asegúrate de que 'firebaseConfig.projectId' tenga un valor
                if (!firebaseConfig.projectId) { // Ahora esto usa la variable correcta
                    throw new Error("firebaseConfig.projectId no está definido. Es necesario.");
                }
                
                // Usamos el projectId como el 'appId' para la colección de la base de datos
                appId = firebaseConfig.projectId; 
                console.log("Usando projectId como appId para la base de datos:", appId);
            }
        
        } catch (e) {
            console.error("Error fatal en la configuración de Firebase. La aplicación no funcionará.", e);
            // Dejamos un objeto vacío para evitar más errores, aunque la app no funcionará
            firebaseConfig = {}; // Asigna a la variable de arriba
            appId = null;
        }
        // --- FIN: Bloque de configuración de Firebase ---


        // Firebase service variables
        let db, auth, userId, poiCollectionRef;
        // Leaflet map variable
        let map;
        // Map markers cache
        let poiMarkers = {};
        // Local cache for POI data
        let allPoisData = [];
        let poiDataMap = new Map(); // Map for quick POI lookup by ID

        // --- Global State ---
        let modelsToPlace = []; // Array of {name, url, isCustomVideo, imageUrl} selected for placement
        let isPlacingModel = false; // Flag if currently in placement mode on map
        let currentPlacingModel = {}; // Data of the model being placed
        let isEditingLocation = false; // Flag if currently editing a POI's location on map
        let currentEditingPoiId = null; // ID of the POI being edited
        let currentEditingMarker = null; // Leaflet marker of the POI being edited
        let firebaseReady = false; // Flag indicates Firebase auth and Firestore are ready

        // AR Specific Variables
        let arScene = null; // Reference to the A-Frame scene element
        let lastKnownGps = { latitude: 0, longitude: 0, accuracy: 9999, heading: null }; // Last GPS data
        let arFineScaleMultiplier = 1.0; // Current value of the fine scale slider in AR view
        let closestPoiIdForScaling = null; // ID of the nearest POI, used for saving scale

        // AR Loading Progress Variables
        let progressBar, progressBarContainer, loadingAssetStatus;
        let totalARAssetsToLoad = 0;
        let loadedARAssetsCount = 0;
        const ASSETS_LOAD_STEP = 50; // Percentage of progress bar dedicated to asset loading

        // AR Guidance Elements
        let arGuide, guideName, guideDistance, guideBearing;
        // (NUEVO) AR Realtime Location Elements
        let arRealtimeLocationEl, realtimeLatEl, realtimeLonEl;
        // AR Scale Slider Elements
        let arScaleSlider, arScaleValueDisplay, saveArScaleBtn;
        // (NUEVO) Screenshot elements
        let screenshotBtn, screenshotCanvas;

        // --- DOM Element References (assigned in DOMContentLoaded) ---
        let pages = {};
        let messageBox, permissionModal, arLoadingScreen, loadingStatusText, versionDisplay;
        let listContainer, loadingPois, ecopiensaSelectionList, loadingModelsPlaceholder, selectVideoCheckbox, clearSelectionBtn;
        let placementPanel, modelsToPlaceList, placementFormContainer, placingModelName, cancelPlacementBtn, savePlacementBtn, backToSelectionBtn;
        let mapZoomSlider, jumptoBtn, placePoiTypeSelect, modelFieldsDiv, videoFieldsDiv, placeModelUrlInput, placeVideoUrlInput, placeNameInput;
        let placeScaleInput, placeHeightInput, placeStartDateInput, placeEndDateInput, placeSoundUrlInput; // Added refs for form inputs
        let placedPoisPanel, placedPoisList, editLocationPanel, editingPoiNameEl, saveEditLocationBtn, cancelEditLocationBtn;
        let summaryPoiList, loadingSummaryPois;
        let gotoMapButton;
        let mapCenterCoordsEl;
        let placementPreviewImageEl;
        // Auth UI elements
        let loginPage, googleLoginBtn, logoutBtn, userInfo, userEmail;
        // Map UI toggle button
        let togglePoisBtn;

        // --- Utility Functions ---

        // Degrees to Radians
        function toRad(degrees) { return degrees * (Math.PI / 180); }
        // Radians to Degrees
        function toDeg(radians) { return radians * (180 / Math.PI); }

        /**
         * Calculates the great-circle distance between two points
         * on the Earth (specified in decimal degrees) using Haversine formula.
         */
        function calculateDistance(lat1, lon1, lat2, lon2) {
            if (lat1 == null || lon1 == null || lat2 == null || lon2 == null) return Infinity; // Handle missing coords
            const R = 6371e3; // Earth radius in meters
            const φ1 = toRad(lat1);
            const φ2 = toRad(lat2);
            const Δφ = toRad(lat2 - lat1);
            const Δλ = toRad(lon2 - lon1);

            const a = Math.sin(Δφ / 2) * Math.sin(Δφ / 2) +
                        Math.cos(φ1) * Math.cos(φ2) *
                        Math.sin(Δλ / 2) * Math.sin(Δλ / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

            return R * c; // Distance in meters
        }

        /**
         * Calculates the initial bearing (angle) between two points.
         */
        function calculateBearing(lat1, lon1, lat2, lon2) {
            if (lat1 == null || lon1 == null || lat2 == null || lon2 == null) return 0; // Handle missing coords
            const φ1 = toRad(lat1);
            const φ2 = toRad(lat2);
            const λ1 = toRad(lon1);
            const λ2 = toRad(lon2);

            const y = Math.sin(λ2 - λ1) * Math.cos(φ2);
            const x = Math.cos(φ1) * Math.sin(φ2) -
                        Math.sin(φ1) * Math.cos(φ2) * Math.cos(λ2 - λ1);

            let bearing = toDeg(Math.atan2(y, x));
            return (bearing + 360) % 360; // Normalize to 0-360 degrees
        }

        /**
         * Converts a bearing difference (relative angle) into a directional arrow/text.
         */
        function getDirectionArrow(bearingDiff) {
            // Normalize diff to -180 to 180 range
            let normalizedDiff = bearingDiff > 180 ? bearingDiff - 360 : bearingDiff;
            normalizedDiff = bearingDiff < -180 ? bearingDiff + 360 : normalizedDiff; // Re-check after potential wrap-around

            if (normalizedDiff >= -22.5 && normalizedDiff <= 22.5) return "↑ (Recto)";
            if (normalizedDiff > 22.5 && normalizedDiff <= 67.5) return "↗ (Semi-derecha)";
            if (normalizedDiff > 67.5 && normalizedDiff <= 112.5) return "→ (Derecha)";
            if (normalizedDiff > 112.5 && normalizedDiff <= 157.5) return "↘ (Atrás-derecha)";
            if (normalizedDiff > 157.5 || normalizedDiff < -157.5) return "↓ (Atrás)";
            if (normalizedDiff < -112.5 && normalizedDiff >= -157.5) return "↙ (Atrás-izquierda)";
            if (normalizedDiff < -67.5 && normalizedDiff >= -112.5) return "← (Izquierda)";
            if (normalizedDiff < -22.5 && normalizedDiff >= -67.5) return "↖ (Semi-izquierda)";
            return "--"; // Should not happen
        }

        /**
         * Displays a temporary message to the user.
         */
        function showMessage(msg, duration = 3000) {
            if (!messageBox) {
                console.warn("Message box not ready:", msg);
                return;
            }
            messageBox.textContent = msg;
            messageBox.classList.add('show');
            // Clear previous timeout if any
            if (messageBox.timeoutId) clearTimeout(messageBox.timeoutId);
            messageBox.timeoutId = setTimeout(() => {
                messageBox.classList.remove('show');
                messageBox.timeoutId = null;
            }, duration);
        }

        /**
         * Updates the AR loading progress bar and status text.
         */
        function updateARProgressBar(step, assetName = '') {
            let progress = 0;
            let statusText = '';

            // Assign progress and status based on the loading step
            switch (step) {
                case 'start':
                    progress = 5;
                    statusText = 'Iniciando verificación de permisos...';
                    loadedARAssetsCount = 0; // Reset asset count
                    break;
                case 'permissions':
                    progress = 20;
                    statusText = 'Permisos de cámara y ubicación concedidos.';
                    break;
                case 'load_assets_start':
                    progress = 25;
                    statusText = `Cargando ${totalARAssetsToLoad} recursos AR...`;
                    break;
                case 'asset_loaded':
                    loadedARAssetsCount++;
                    const assetProgress = totalARAssetsToLoad > 0 ? (loadedARAssetsCount / totalARAssetsToLoad) * ASSETS_LOAD_STEP : ASSETS_LOAD_STEP;
                    progress = 25 + assetProgress;
                    statusText = `Cargando recursos AR (${loadedARAssetsCount}/${totalARAssetsToLoad})...`;
                    loadingAssetStatus.textContent = `Descargando: ${assetName}`;
                    break;
                case 'scene_setup':
                    progress = 80;
                    statusText = 'Configurando escena de Realidad Aumentada...';
                    loadingAssetStatus.textContent = 'Enlazando recursos...';
                    break;
                case 'gps_active':
                    progress = 95;
                    statusText = 'Esperando precisión de ubicación...';
                    loadingAssetStatus.textContent = 'GPS Activo';
                    break;
                case 'complete':
                    progress = 100;
                    statusText = '¡Realidad Aumentada lista!';
                    loadingAssetStatus.textContent = '¡Listo!';
                    break;
                default:
                    console.warn("Unknown progress step:", step);
                    return;
            }

            // Update UI elements
            if (progressBar) progressBar.style.width = `${progress}%`;
            if (loadingStatusText) loadingStatusText.textContent = statusText;
            console.log(`AR Load: Step ${step}, Progress ${progress.toFixed(0)}%, Assets ${loadedARAssetsCount}/${totalARAssetsToLoad}`);
        }

        /**
         * Navigates between different pages (views) of the application.
         */
        function navigateTo(pageName) {
            // Ensure pages object is populated
            if (Object.keys(pages).length === 0) {
                console.error("Pages object not ready for navigation.");
                return;
            }

            // Block navigation to protected pages if Firebase isn't ready
            if (pageName !== 'login' && !firebaseReady) {
                 if (['map', 'summary', 'ar'].includes(pageName)) {
                     showMessage("Aguarde un momento, conectando con la base de datos...", 3000);
                 }
                console.warn(`Navigation to ${pageName} blocked, Firebase not ready.`);
                return;
            }

            console.log(`Navigating to: ${pageName}`);
            // Deactivate all pages
            Object.values(pages).forEach(p => p?.classList.remove('active'));

            // Activate the target page
            if(pages[pageName]) {
                pages[pageName].classList.add('active');
            } else {
                console.error(`Page not found: ${pageName}. Falling back to login.`);
                if (pages.login) pages.login.classList.add('active'); // Fallback to login
                 return;
            }

            // Page-specific initialization/cleanup logic
            if (pageName === 'map') {
                stopAR(); // Ensure AR is stopped when going to map
                setTimeout(initMap, 100); // Initialize map after slight delay
            } else if (pageName === 'summary') {
                stopAR(); // Ensure AR is stopped
                stopMap(); // Stop map updates
                populateSummaryPage(); // Populate summary list
            } else if (pageName === 'ar') {
                stopMap(); // Stop map updates
                startARFlow(); // Start the AR experience flow
            } else if (pageName === 'admin') {
                stopAR(); // Ensure AR is stopped
                stopMap(); // Stop map updates
                initializeModelSelection(); // Refresh model selection UI
            } else if (pageName === 'login') {
                stopAR(); // Ensure AR is stopped
                stopMap(); // Stop map updates
            }
        }

        /**
         * Cleans up the Leaflet map instance and related listeners.
         */
        function stopMap() {
            if (map) {
                map.off('move', updateCenterCoordsDisplay);
                map.off('zoomend', handleMapZoomEnd);
                 // Remove POI delete listener if attached
                if (placedPoisList) {
                   placedPoisList.removeEventListener('click', handleDeletePoiOnMap);
                }
                map.remove(); // Properly remove the map instance
                map = null;
                // Clear marker references
                Object.values(poiMarkers).forEach(marker => marker.remove()); // Should be handled by map.remove(), but good practice
                poiMarkers = {};
                console.log("Map stopped and removed.");
            }
            // Reset map interaction states
            isPlacingModel = false;
            isEditingLocation = false;
            currentEditingPoiId = null;
            currentEditingMarker = null;
            // Ensure POIs panel is visible next time map opens
            if (placedPoisPanel) placedPoisPanel.classList.remove('minimized');
            if (togglePoisBtn) togglePoisBtn.textContent = 'Ocultar POIs';
        }

        // --- Persistence Functions (Local Storage for Model Selection) ---

        /**
         * Saves the current model/video selection (modelsToPlace array) to local storage.
         */
        function saveSelectionToLocalStorage() {
            try {
                localStorage.setItem(LOCALSTORAGE_KEY, JSON.stringify(modelsToPlace));
                console.log("Selection saved to localStorage:", modelsToPlace);
            } catch (e) {
                console.error("Error saving selection to localStorage:", e);
                showMessage("Error guardando selección localmente.", 4000);
            }
        }

        /**
         * Loads the model/video selection from local storage into the modelsToPlace array.
         */
        function loadSelectionFromLocalStorage() {
            const savedSelection = localStorage.getItem(LOCALSTORAGE_KEY);
            if (savedSelection) {
                try {
                    modelsToPlace = JSON.parse(savedSelection);
                    // Ensure it's always an array
                    if (!Array.isArray(modelsToPlace)) modelsToPlace = [];
                    console.log("Loaded model selection from localStorage:", modelsToPlace);
                } catch (e) {
                    console.error("Error parsing saved selection:", e);
                    localStorage.removeItem(LOCALSTORAGE_KEY); // Clear potentially corrupted data
                    modelsToPlace = []; // Reset
                }
            } else {
                modelsToPlace = []; // Initialize empty if nothing saved
                console.log("No selection found in localStorage, initializing empty.");
            }
        }

        /**
         * Clears the saved selection from local storage and updates the UI.
         */
         function clearSavedSelection() {
             localStorage.removeItem(LOCALSTORAGE_KEY);
             modelsToPlace = [];
             initializeModelSelection(); // Update admin page UI immediately
             showMessage("Selección guardada limpiada.", 2000);
             console.log("Cleared saved selection.");
         }

        // --- Firebase Initialization and Authentication ---

        /**
         * Initializes Firebase app, Auth, Firestore, and sets up the auth state listener.
         */
        async function initializeFirebase() {
            console.log("Initializing Firebase...");
            if (loadingPois) loadingPois.textContent = "Inicializando conexión Firebase...";
            if (gotoMapButton) gotoMapButton.disabled = true; // Disable map button until ready

            // Basic validation of Firebase config
            if (!firebaseConfig || !firebaseConfig.projectId || !appId || appId === 'default-app-id-fallback') {
                const errorMsg = "Error fatal: Configuración de Firebase inválida o incompleta. Revisa el script.";
                console.error(errorMsg, firebaseConfig);
                if(loadingPois) loadingPois.textContent = errorMsg;
                showMessage(errorMsg, 10000);
                 return;
            }

            try {
                // Initialize Firebase App and services
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                console.log("Firestore and Auth services obtained.");
                setLogLevel('debug'); // Enable Firestore debug logging

                // Listen for changes in user authentication state
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        // --- User is Signed In ---
                        userId = user.uid;
                        console.log('Firebase User Authenticated. UID:', userId);
                        // Update UI with user info
                        if (userEmail) userEmail.textContent = user.email || userId;
                        if (userInfo) userInfo.classList.remove('hidden');
                        if (logoutBtn) logoutBtn.classList.remove('hidden');

                        // (SOLUCIÓN FIREBASE 2/2)
                        // Construye la ruta de la colección usando la variable 'appId' (projectId o __app_id)
                        const collectionPath = `/artifacts/${appId}/users/${userId}/pois`;
                        poiCollectionRef = collection(db, collectionPath);
                        console.log('POI Collection configurado para:', collectionPath);

                        firebaseReady = true; // Mark Firebase as ready
                        if (gotoMapButton) gotoMapButton.disabled = false; // Enable map button
                        if (loadingPois?.textContent.startsWith("Inicializando")) {
                             loadingPois.textContent = "Conexión exitosa. Cargando POIs...";
                           }
                        showMessage(`Bienvenido, ${user.displayName || user.email}`, 2000);

                        // Start listening for POI data changes
                        loadAndListenPois();

                        // Navigate to admin page if user was on login page
                        if (pages.login?.classList.contains('active')) {
                             navigateTo('admin');
                        }

                      } else {
                        // --- User is Signed Out ---
                        userId = null;
                        poiCollectionRef = null;
                        firebaseReady = false; // Mark Firebase as not ready
                        console.log('Firebase User signed out.');
                        if (gotoMapButton) gotoMapButton.disabled = true; // Disable map button
                        // Update UI for signed-out state
                        if (userInfo) userInfo.classList.add('hidden');
                        if (logoutBtn) logoutBtn.classList.add('hidden');
                        if (userEmail) userEmail.textContent = "";

                        // Clear local data and UI lists
                        if (listContainer) listContainer.innerHTML = '<p class="text-gray-500 font-semibold">Inicia sesión para ver tus datos.</p>';
                        allPoisData = [];
                        poiDataMap.clear();

                        // Force navigation to login page
                        navigateTo('login');
                    }
                });
                console.log("Auth state listener attached.");

            } catch (initError) {
                console.error("Firebase Initialization Error:", initError);
                firebaseReady = false;
                 if (gotoMapButton) gotoMapButton.disabled = true;
                const errorMsg = `Error fatal al inicializar Firebase: ${initError.message}. Verifica la config y la conexión.`;
                if(loadingPois) loadingPois.textContent = errorMsg;
                showMessage(errorMsg, 10000);
            }
        }

        /**
         * Handles the Google Sign-In process via popup.
         */
         async function handleGoogleLogin() {
             const provider = new GoogleAuthProvider();
             if (!auth) {
                 console.error("Auth service not initialized.");
                 showMessage("Error: Servicio de autenticación no listo.", 3000);
                 return;
             }
             try {
                 await signInWithPopup(auth, provider);
                 // onAuthStateChanged will handle navigation and setup
             } catch (error) {
                 console.error("Google Login Error:", error);
                 showMessage("Error al iniciar sesión: " + (error.message || "Intenta de nuevo."), 5000);
             }
         }

        /**
         * Handles the user sign-out process.
         */
         async function handleLogout() {
             if (!auth) {
                 console.error("Auth service not initialized.");
                 return;
             }
             try {
                 await signOut(auth);
                 showMessage("Sesión cerrada.", 2000);
                 // onAuthStateChanged will handle cleanup and navigation to login
             } catch (error) {
                 console.error("Logout Error:", error);
                 showMessage("Error al cerrar sesión.", 3000);
             }
         }

        /**
         * Displays the current app version in the UI.
         */
         function displayAppVersion() {
             if (versionDisplay) {
                 versionDisplay.textContent = `v${APP_VERSION}`;
             }
         }

        // --- Admin Page - Model Selection Logic ---

        /**
         * Initializes the checkboxes for model/video selection on the admin page.
         */
         function initializeModelSelection() {
             // Ensure required elements are available
             if (!ecopiensaSelectionList || !loadingModelsPlaceholder || !selectVideoCheckbox) {
                 console.error("Admin page elements for model selection not found.");
                 return;
             }

             loadingModelsPlaceholder.style.display = 'none'; // Hide loading text
             ecopiensaSelectionList.innerHTML = ''; // Clear previous checkboxes

             // Create checkboxes for predefined Ecopiensa models
             ECOPIENSA_MODELS.forEach(model => {
                 const isSelected = modelsToPlace.some(m => !m.isCustomVideo && m.url === model.modelUrl);
                 createCheckbox(model.name, model.modelUrl, isSelected, false, model.imageUrl);
             });

             // Set up the custom video checkbox
             selectVideoCheckbox.removeEventListener('change', handleVideoCheckboxChange); // Prevent duplicate listeners
             selectVideoCheckbox.addEventListener('change', handleVideoCheckboxChange);
             selectVideoCheckbox.checked = modelsToPlace.some(m => m.isCustomVideo); // Set initial state
         }

        /**
         * Creates a single checkbox element for the selection list.
         */
        function createCheckbox(name, url, isChecked, isVideoPlaceholder = false, imageUrl = '') {
            if (!ecopiensaSelectionList) return;

            const label = document.createElement('label');
            label.className = 'flex items-center space-x-2 p-2 border rounded-md hover:bg-gray-50 cursor-pointer transition duration-150 ease-in-out';
            const input = document.createElement('input');
            input.type = 'checkbox';
            input.className = 'model-select-cb h-5 w-5 text-blue-600 focus:ring-blue-500 border-gray-300 rounded';
            // Store data attributes for easy access in event handler
            input.dataset.name = name;
            input.dataset.url = url;
            input.checked = isChecked;
            input.dataset.imageUrl = imageUrl;
            if (isVideoPlaceholder) {
                 input.dataset.isCustomVideo = "true";
            }

            // Attach change listener
            input.removeEventListener('change', handleCheckboxChange); // Prevent duplicates
            input.addEventListener('change', handleCheckboxChange);

            const span = document.createElement('span');
            span.textContent = name;
            span.className = 'text-sm font-medium text-gray-700';

            label.appendChild(input);
            label.appendChild(span);
            ecopiensaSelectionList.appendChild(label);
        }

        /**
         * Handles changes to the "Custom Video" checkbox.
         */
         function handleVideoCheckboxChange(e) {
             const placeholderExists = modelsToPlace.some(m => m.isCustomVideo);
             if (e.target.checked) {
                 // Add video placeholder if it doesn't exist
                 if (!placeholderExists) {
                     modelsToPlace.push({...CUSTOM_VIDEO_PLACEHOLDER});
                 }
             } else {
                 // Remove video placeholder if it exists
                 if (placeholderExists) {
                     modelsToPlace = modelsToPlace.filter(m => !m.isCustomVideo);
                 }
             }
             saveSelectionToLocalStorage(); // Persist changes
             console.log("Models to place (video toggle):", modelsToPlace);
         }

        /**
         * Handles changes to individual model checkboxes.
         */
        function handleCheckboxChange(e) {
            const itemData = {
                 name: e.target.dataset.name,
                 url: e.target.dataset.url,
                 isCustomVideo: e.target.dataset.isCustomVideo === "true",
                 imageUrl: e.target.dataset.imageUrl || ''
            };
            const itemExists = modelsToPlace.some(m => m.url === itemData.url);

            if (e.target.checked) {
                 // Add item if it doesn't exist
                 if (!itemExists) {
                     modelsToPlace.push(itemData);
                 }
            } else {
                 // Remove item if it exists
                 if (itemExists) {
                     modelsToPlace = modelsToPlace.filter(m => m.url !== itemData.url);
                 }
            }
            saveSelectionToLocalStorage(); // Persist changes
            console.log("Models to place updated:", modelsToPlace);
         }

        // --- Firestore Data Handling ---

        /**
         * Loads POI data from Firestore and listens for real-time updates.
         */
        function loadAndListenPois() {
            // Check if Firestore reference is ready
            if (!poiCollectionRef) {
                 console.warn("loadAndListenPois called before poiCollectionRef is set (user might be logged out).");
                 if (loadingPois) loadingPois.textContent = "Esperando inicio de sesión...";
                 return;
            }
            // Check if UI elements are ready
            if (!listContainer || !loadingPois) {
                 console.error("Admin page POI list elements not found.");
                 return;
            }

            if (loadingPois) {
                 loadingPois.textContent = "Cargando puntos guardados...";
                 loadingPois.style.display = 'block';
            }

            // Create Firestore query and attach snapshot listener
            const q = query(poiCollectionRef);
            onSnapshot(q, (querySnapshot) => {
                 console.log("Firestore snapshot received.");
                 if (!listContainer || !loadingPois) return; // Re-check elements

                 loadingPois.style.display = 'none'; // Hide loading indicator
                 // Clear local data caches
                 allPoisData = [];
                 poiDataMap.clear();
                 // Clear admin list UI only if admin page is active
                 if (pages.admin?.classList.contains('active')) {
                     listContainer.innerHTML = '';
                 }

                 // Handle empty snapshot
                 if (querySnapshot.empty) {
                      console.log("Query snapshot is empty.");
                      if (pages.admin?.classList.contains('active')) {
                           listContainer.innerHTML = '<p class="text-gray-500">No hay contenido guardado en Firebase.</p>';
                      }
                      // Update map if active (to remove deleted markers)
                      if (map && pages.map?.classList.contains('active')) {
                           updateMapMarkersAndPlacedList();
                      }
                      return;
                 }

                 // Process each document in the snapshot
                 querySnapshot.forEach((doc) => {
                      const poi = { id: doc.id, ...doc.data() };
                      // Add default arScaleMultiplier if missing
                      if (poi.arScaleMultiplier === undefined) {
                           poi.arScaleMultiplier = 1.0;
                      }
                      allPoisData.push(poi);
                      poiDataMap.set(poi.id, poi); // Add to Map for quick lookup

                      // Populate Admin list (Page 1) ONLY if admin page is active
                      if (pages.admin?.classList.contains('active')) {
                           const poiElement = document.createElement('div');
                           poiElement.className = 'poi-item p-4 border border-gray-200 rounded-lg shadow-sm grid grid-cols-2 md:grid-cols-4 gap-4 items-center';
                           let typeLabel = poi.poiType === 'video' ? 'Video' : 'Modelo 3D';
                           let urlToShow = poi.poiType === 'video' ? (poi.videoUrl || 'N/A') : (poi.modelUrl || 'N/A');
                           if (urlToShow.length > 30) urlToShow = urlToShow.substring(0, 27) + '...'; // Truncate long URLs

                           poiElement.innerHTML = `
                                <div>
                                    <strong class="block text-sm text-gray-800">${poi.name || 'Sin Nombre'}</strong>
                                    <span class="block text-xs ${poi.poiType === 'video' ? 'text-purple-600' : 'text-blue-600'}">${typeLabel}</span>
                                    <span class="block text-xs text-gray-500" title="${poi.poiType === 'video' ? poi.videoUrl : poi.modelUrl}">URL: ${urlToShow}</span>
                                </div>
                                <div class="text-sm">
                                    <span class="block">Lat: ${poi.lat?.toFixed(6) || 'N/A'}</span>
                                    <span class="block">Lon: ${poi.lon?.toFixed(6) || 'N/A'}</span>
                                </div>
                                <div class="text-sm">
                                    <span class="block">Inicio: ${poi.startDate || 'N/A'}</span>
                                    <span class="block">Fin: ${poi.endDate || 'N/A'}</span>
                                </div>
                                <div class="text-right">
                                    <button data-id="${poi.id}" class="delete-btn bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg text-sm transition duration-300">
                                        Eliminar
                                    </button>
                                </div>
                           `;
                           listContainer.appendChild(poiElement);
                      }
                 });

                 console.log(`Local cache 'allPoisData' updated with ${allPoisData.length} POIs.`);

                 // Update map if it's currently active
                 if (map && pages.map?.classList.contains('active')) {
                      updateMapMarkersAndPlacedList();
                      populatePlacementPanel(); // Refresh available models panel
                      if (togglePoisBtn) togglePoisBtn.style.display = 'block'; // Ensure toggle button is visible
                 }

                 // Update summary page if it's currently active
                 if (pages.summary?.classList.contains('active')) {
                      populateSummaryPage();
                 }

            }, (error) => {
                 // Handle Firestore errors
                 console.error("Error listening to POIs (Firestore):", error);
                 if (loadingPois) loadingPois.style.display = 'none';
                 if (listContainer) listContainer.innerHTML = `<p class="text-red-500 font-semibold">Error al cargar datos de Firestore: ${error.message}. Verifica las reglas de seguridad y la conexión.</p>`;
                 // Clear local data on error
                 allPoisData = [];
                 poiDataMap.clear();
                 showMessage("Error al actualizar la lista de contenido.", 5000);
            });
         }

        // --- Map Page Logic (Leaflet) ---

        /**
         * Initializes the Leaflet map and its associated controls and listeners.
         */
        function initMap() {
            console.log("Initializing Map...");
            // Ensure Firebase is ready before initializing map
            if (!firebaseReady || !poiCollectionRef) {
                 showMessage("La base de datos no está lista. Por favor espere...", 3000);
                 navigateTo('login'); // Redirect to login if Firebase isn't ready
                 return;
            }
            // If map already exists, just refresh its size and content
            if (map) {
                 console.log("Map already exists. Invalidating size.");
                 setTimeout(() => { if (map) map.invalidateSize(); }, 100); // Invalidate size after slight delay
                 populatePlacementPanel(); // Refresh models available for placement
                 updateMapMarkersAndPlacedList(); // Refresh markers and list
                 return;
            }

            const mapContainer = document.getElementById('map-canvas');
            if (!mapContainer) { console.error("Map container element (#map-canvas) not found."); return; }
            // Default center coordinates (Tuluá)
            const defaultCenter = [4.0835, -76.1915];
            // Initialize Leaflet map
            map = L.map(mapContainer, { zoomControl: false, preferCanvas: true }).setView(defaultCenter, 15);

            // Add Google Satellite tile layer
            L.tileLayer('https://mt1.google.com/vt/lyrs=s,h&x={x}&y={y}&z={z}', {
                 maxZoom: 22, // High max zoom for detail
                 subdomains: ['mt0', 'mt1', 'mt2', 'mt3'], // Google subdomains
                 attribution: 'Imagery &copy;2025 Google'
            }).addTo(map);

            // Initial population of map content
            updateMapMarkersAndPlacedList();
            populatePlacementPanel();
            cancelPlacement(); // Ensure placement form is hidden
            cancelEditLocation(); // Ensure edit form is hidden

            // Attach map event listeners
            map.off('move', updateCenterCoordsDisplay); // Remove previous listener if any
            map.on('move', updateCenterCoordsDisplay); // Update coords display on move
            updateCenterCoordsDisplay(); // Initial coords display

            // Connect map zoom slider
            if (mapZoomSlider) {
                 mapZoomSlider.value = map.getZoom();
                 mapZoomSlider.removeEventListener('input', handleZoomSlider);
                 mapZoomSlider.addEventListener('input', handleZoomSlider);
            }
            map.off('zoomend', handleMapZoomEnd);
            map.on('zoomend', handleMapZoomEnd); // Update slider when map zoom changes

            // Connect "Jump To" button
            if (jumptoBtn) {
                 jumptoBtn.removeEventListener('click', jumpToCoords);
                 jumptoBtn.addEventListener('click', jumpToCoords);
            }

            // Connect POI Type dropdown
            if (placePoiTypeSelect) {
                 placePoiTypeSelect.removeEventListener('change', handlePoiTypeChange);
                 placePoiTypeSelect.addEventListener('change', handlePoiTypeChange);
                 handlePoiTypeChange(); // Initial setup based on default value
             }

            // Attach delete listener to the placed POIs list container
            if (placedPoisList) {
                 placedPoisList.removeEventListener('click', handleDeletePoiOnMap);
                 placedPoisList.addEventListener('click', handleDeletePoiOnMap);
            }

            // Attach listener for toggling the placed POIs panel
            if (togglePoisBtn) {
                 togglePoisBtn.removeEventListener('click', handleTogglePoisPanel);
                 togglePoisBtn.addEventListener('click', handleTogglePoisPanel);
                 togglePoisBtn.style.display = 'block'; // Ensure visibility
            }

            // Invalidate map size after a short delay to ensure correct rendering
            setTimeout(() => { if (map) map.invalidateSize(); }, 200);
            console.log("Map initialization complete.");
         }

        /**
         * Toggles the visibility (minimized state) of the placed POIs panel.
         */
        function handleTogglePoisPanel() {
             if (placedPoisPanel && togglePoisBtn) {
                 const isMinimized = placedPoisPanel.classList.toggle('minimized');
                 togglePoisBtn.textContent = isMinimized ? 'Mostrar POIs' : 'Ocultar POIs';
             }
         }

        /**
         * Updates the display showing the current center coordinates of the map.
         */
         function updateCenterCoordsDisplay() {
             if (map && mapCenterCoordsEl) {
                 const center = map.getCenter();
                 mapCenterCoordsEl.innerHTML = `
                     <span>Lat: ${center.lat.toFixed(6)}</span>
                     <span>Lon: ${center.lng.toFixed(6)}</span>
                 `;
             }
         }

        /**
         * Updates the markers on the map and the list in the placed POIs panel
         * based on the current `allPoisData`.
         */
        function updateMapMarkersAndPlacedList() {
             if (!map || !placedPoisList) {
                 console.warn("Cannot update map markers/list: Map or list element not ready.");
                 return;
             }
             console.log("Updating map markers and placed POIs list...");

             // Remove existing markers from the map
             Object.values(poiMarkers).forEach(marker => {
                 if (map.hasLayer(marker)) map.removeLayer(marker);
             });
             poiMarkers = {}; // Clear marker cache
             placedPoisList.innerHTML = ''; // Clear list UI

             let hasPois = false;
             // Iterate through all POI data
             allPoisData.forEach(poi => {
                 hasPois = true;
                 // Add marker if coordinates are valid
                 if (typeof poi.lat === 'number' && typeof poi.lon === 'number') {
                     let iconUrl = 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png'; // Default blue for models
                      if (poi.poiType === 'video') {
                         iconUrl = 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-violet.png'; // Violet for videos
                      }

                     // Get preview image URL
                     let popupImageUrl = '';
                     if (poi.poiType === 'model' && poi.modelUrl) {
                         const ecoModel = ECOPIENSA_MODELS.find(m => m.modelUrl === poi.modelUrl);
                         if (ecoModel) popupImageUrl = ecoModel.imageUrl;
                     } else if (poi.poiType === 'video') {
                          popupImageUrl = CUSTOM_VIDEO_PLACEHOLDER.imageUrl; // Use video placeholder image
                      }

                     // Create popup content with name and preview image
                     let popupContent = `<b>${poi.name || 'Sin Nombre'}</b> (${poi.poiType || 'model'})`;
                     if (popupImageUrl) {
                         popupContent += `<br><img src="${popupImageUrl}" alt="Preview" class="popup-image" onerror="this.style.display='none'">`; // Add image with error fallback
                     }

                     // Create Leaflet marker
                     const marker = L.marker([poi.lat, poi.lon], {
                          icon: L.icon({ // Custom colored icon
                              iconUrl: iconUrl,
                              shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                              iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
                          })
                     })
                         .addTo(map)
                         .bindPopup(popupContent); // Add popup
                     poiMarkers[poi.id] = marker; // Store marker reference
                 } else { console.warn("POI for map missing coordinates:", poi.id, poi.name); }

                 // Add item to the placed POIs list UI
                 const listItem = document.createElement('div');
                 listItem.className = 'placed-poi-item p-2 border-b flex justify-between items-center';
                 listItem.innerHTML = `
                     <span class="text-sm font-medium">${poi.name || 'Sin Nombre'}</span>
                     <div>
                         <button data-id="${poi.id}" class="edit-location-btn bg-amber-500 hover:bg-amber-600 text-white text-xs px-2 py-1 rounded">
                             Editar Loc.
                         </button>
                         <button data-id="${poi.id}" class="delete-btn-map">
                             Eliminar
                         </button>
                     </div>
                 `;
                 // Attach click listener for editing location
                 const editBtn = listItem.querySelector('.edit-location-btn');
                 editBtn.removeEventListener('click', handleEditLocationClick); // Prevent duplicates
                 editBtn.addEventListener('click', handleEditLocationClick);
                 placedPoisList.appendChild(listItem);
             });

             // Display message if no POIs are found
             if (!hasPois) {
                 placedPoisList.innerHTML = '<p class="text-sm text-gray-500">Aún no hay contenido guardado en el mapa.</p>';
             }
             console.log(`Updated ${Object.keys(poiMarkers).length} markers and placed POIs panel.`);
         }

        /**
         * Handles changes in the POI Type dropdown in the placement form.
         */
        function handlePoiTypeChange() {
             // Ensure elements are ready
             if (!placePoiTypeSelect || !modelFieldsDiv || !videoFieldsDiv || !placeModelUrlInput || !placeVideoUrlInput) {
                 console.error("POI type change handler missing required form elements."); return;
             }
             const selectedType = placePoiTypeSelect.value;
             const isVideo = selectedType === 'video';

             // Show/hide relevant form sections
             modelFieldsDiv.classList.toggle('hidden', isVideo);
             videoFieldsDiv.classList.toggle('hidden', !isVideo);

             // Enable/disable URL inputs
             placeModelUrlInput.disabled = isVideo;
             placeVideoUrlInput.disabled = !isVideo;

             // Update scale label text
             const scaleLabel = document.querySelector('label[for="place-scale"]');
             if (scaleLabel) { scaleLabel.textContent = isVideo ? 'Ancho del Video (metros)' : 'Escala Base del Modelo'; }
         }

        /**
         * Handles clicks on the "Edit Loc." button in the placed POIs list.
         */
         function handleEditLocationClick(e) {
             const poiId = e.target?.dataset?.id; // Safely get POI ID from button
             if (poiId) { startEditLocation(poiId); }
             else { console.error("Could not get POI ID from edit button."); }
         }

        /**
         * Enters the location editing mode for a specific POI.
         */
        function startEditLocation(poiId) {
             if (isPlacingModel) cancelPlacement(); // Exit placement mode if active
             const poiData = poiDataMap.get(poiId); // Get POI data from cache
             const marker = poiMarkers[poiId]; // Get marker reference
             if (!poiData || !marker || !map) { // Ensure data, marker, and map exist
                 showMessage("Error: No se pudieron encontrar los datos o el marcador del POI.", 4000); return;
             }

             isEditingLocation = true; // Set editing flag
             currentEditingPoiId = poiId; // Store ID of POI being edited
             currentEditingMarker = marker; // Store marker reference

             // Update UI for editing mode
             if (editingPoiNameEl) editingPoiNameEl.textContent = `Moviendo: ${poiData.name || 'Sin Nombre'}`;
             if (placementPanel) placementPanel.classList.add('hidden'); // Hide placement panel
             if (placedPoisPanel) placedPoisPanel.classList.add('hidden'); // Hide placed POIs panel
             if (editLocationPanel) editLocationPanel.classList.remove('hidden'); // Show edit panel

             // Center map on the POI being edited
             map.setView(marker.getLatLng(), 19); // High zoom for precise editing
             showMessage("Modo Edición: Mueve el mapa (la cruz indica la nueva ubicación) y guarda.", 5000);
         }

        /**
         * Cancels the location editing mode and restores the UI.
         */
        function cancelEditLocation() {
             isEditingLocation = false; // Reset flag
             currentEditingPoiId = null; // Clear editing ID
             currentEditingMarker = null; // Clear marker reference
             // Restore panel visibility
             if (placementPanel) placementPanel.classList.remove('hidden');
             if (placedPoisPanel) placedPoisPanel.classList.remove('hidden');
             if (editLocationPanel) editLocationPanel.classList.add('hidden');
         }

        /**
         * Saves the new location (current map center) for the POI being edited to Firestore.
         */
         async function handleSaveEditLocation() {
             // Ensure editing mode is active and necessary variables are set
             if (!isEditingLocation || !map || !poiCollectionRef || !currentEditingPoiId || !saveEditLocationBtn) { return; }

             const newLatLng = map.getCenter(); // Get new coordinates from map center
             showMessage('Actualizando ubicación...', 2000);
             // Disable button during save operation
             saveEditLocationBtn.disabled = true;
             saveEditLocationBtn.textContent = 'Guardando...';

             try {
                 // Get Firestore document reference and update coordinates
                 const docRef = doc(db, poiCollectionRef.path, currentEditingPoiId);
                 await updateDoc(docRef, { lat: newLatLng.lat, lon: newLatLng.lng });
                 showMessage('¡Ubicación actualizada!', 3000);
                 cancelEditLocation(); // Exit editing mode on success
             } catch (error) {
                 console.error("Error updating location:", error);
                 showMessage("Error guardando nueva ubicación: " + error.message, 5000);
             } finally {
                 // Re-enable button
                 if (saveEditLocationBtn) {
                     saveEditLocationBtn.disabled = false;
                     saveEditLocationBtn.textContent = 'Guardar Nueva Ubicación (en la Cruz)';
                 }
             }
         }

        /**
         * Handles input changes on the map zoom slider.
         */
        function handleZoomSlider(e) { if (map) map.setZoom(parseFloat(e.target.value)); }
        /**
         * Updates the zoom slider value when the map zoom changes.
         */
        function handleMapZoomEnd() { if (map && mapZoomSlider) mapZoomSlider.value = map.getZoom(); }
        /**
         * Moves the map view to the coordinates entered in the "Jump To" input fields.
         */
        function jumpToCoords() {
             const latInput = document.getElementById('jumpto-lat');
             const lonInput = document.getElementById('jumpto-lon');
             if (!latInput || !lonInput || !map) return;
             const lat = parseFloat(latInput.value);
             const lon = parseFloat(lonInput.value);
             // Validate coordinates
             if (isNaN(lat) || isNaN(lon) || lat < -90 || lat > 90 || lon < -180 || lon > 180) {
                 showMessage("Ingresa latitud (-90 a 90) y longitud (-180 a 180) válidas.", 4000); return;
             }
             map.setView([lat, lon], 18); // Set view with high zoom
         }

        /**
         * Populates the placement panel with buttons for each selected model/video.
         */
        function populatePlacementPanel() {
             // Ensure Firebase is ready and UI element exists
             if (!firebaseReady || !modelsToPlaceList) {
                 if (modelsToPlaceList) modelsToPlaceList.innerHTML = '<p class="text-sm text-gray-500">Esperando conexión...</p>';
                 return;
             }
             console.log("Populating placement panel. Current modelsToPlace:", modelsToPlace);

             modelsToPlaceList.innerHTML = ''; // Clear previous buttons

             // Display message if no content is selected
             if (modelsToPlace.length === 0) {
                 modelsToPlaceList.innerHTML = '<p class="text-sm text-gray-500">No hay contenido seleccionado. Vuelve al Panel.</p>';
                 return;
             }

             // Create a button for each selected item
             modelsToPlace.forEach((item) => {
                 const button = document.createElement('button');
                 button.className = 'place-btn control-button bg-blue-500 hover:bg-blue-600 w-full text-left';
                 button.textContent = `Posicionar ${item.name}`;
                 // Store item data in button's dataset
                 button.dataset.name = item.name;
                 button.dataset.url = item.url;
                 button.dataset.imageUrl = item.imageUrl || '';
                 if (item.isCustomVideo) { button.dataset.isCustomVideo = "true"; }

                 // Attach click listener
                 button.removeEventListener('click', handlePlaceButtonClick); // Prevent duplicates
                 button.addEventListener('click', handlePlaceButtonClick);

                 modelsToPlaceList.appendChild(button);
             });
             console.log(`Populated placement panel with ${modelsToPlace.length} items.`);
         }

        /**
         * Handles clicks on the "Posicionar" buttons in the placement panel.
         */
        function handlePlaceButtonClick(e) {
             const targetUrl = e.target.dataset.url;
             // Reconstruct item data from button's dataset
             const itemData = {
                 name: e.target.dataset.name,
                 url: targetUrl,
                 imageUrl: e.target.dataset.imageUrl,
                 isCustomVideo: e.target.dataset.isCustomVideo === "true"
             };
             // Verify item still exists in the global selection state
             const itemExistsInState = modelsToPlace.some(m => m.url === targetUrl);
             if (itemExistsInState) {
                 startPlacement(itemData); // Start placement process
             } else {
                 console.error("Attempted to place item no longer in modelsToPlace state:", itemData);
                 showMessage("Error: Este item ya no está seleccionado.", 4000);
                 populatePlacementPanel(); // Refresh list to reflect current state
             }
         }

        /**
         * Enters the POI placement mode, showing the configuration form.
         */
        function startPlacement(itemData) {
             console.log("Starting placement for:", itemData);
             const isCustomVideo = itemData.isCustomVideo === true;

             isPlacingModel = true; // Set placement flag
             currentPlacingModel = { ...itemData }; // Store data of the item being placed

             // Update form header and preview image
             if (placingModelName) placingModelName.textContent = `Posicionando: ${currentPlacingModel.name}`;
             if (placementPreviewImageEl) {
                 if (itemData.imageUrl) {
                     placementPreviewImageEl.src = itemData.imageUrl;
                     placementPreviewImageEl.style.display = 'block';
                     // Add error handler for broken image links
                     placementPreviewImageEl.onerror = () => {
                         console.warn("Could not load preview image:", itemData.imageUrl);
                         placementPreviewImageEl.style.display = 'none';
                         placementPreviewImageEl.onerror = null; // Prevent infinite loop
                     };
                 } else {
                     placementPreviewImageEl.style.display = 'none'; // Hide if no image URL
                 }
              }

             // Pre-fill form fields based on item data and defaults
             if (placePoiTypeSelect) {
                 placePoiTypeSelect.value = isCustomVideo ? 'video' : 'model';
                 handlePoiTypeChange(); // Update form visibility based on type
              }
             if (placeNameInput) placeNameInput.value = currentPlacingModel.name; // Default name
             if (placeModelUrlInput) placeModelUrlInput.value = isCustomVideo ? '' : currentPlacingModel.url; // Fill model URL if model type
             if (placeVideoUrlInput) placeVideoUrlInput.value = ''; // Clear video URL initially

             // Reset other fields to defaults
             if (placeScaleInput) placeScaleInput.value = '1.0';
             if (placeHeightInput) placeHeightInput.value = '0.0';
             if (placeSoundUrlInput) placeSoundUrlInput.value = '';

             // Set default start/end dates
             const today = new Date().toISOString().split('T')[0];
             const nextMonthDate = new Date();
             nextMonthDate.setMonth(nextMonthDate.getMonth() + 1);
             const nextMonth = nextMonthDate.toISOString().split('T')[0];
             if (placeStartDateInput) placeStartDateInput.value = today;
             if (placeEndDateInput) placeEndDateInput.value = nextMonth;

             // Show form, hide selection list
             if (modelsToPlaceList) modelsToPlaceList.classList.add('hidden');
             if (placementFormContainer) placementFormContainer.classList.remove('hidden');

             showMessage(`Mueve el mapa (la cruz indica la ubicación) y presiona 'Guardar Ubicación'`);
         }

        /**
         * Cancels the POI placement mode, hiding the form and showing the selection list.
         */
        function cancelPlacement() {
             isPlacingModel = false; // Reset flag
             currentPlacingModel = {}; // Clear current item data
             // Restore UI
             if (placementFormContainer) placementFormContainer.classList.add('hidden');
             if (modelsToPlaceList) modelsToPlaceList.classList.remove('hidden');
             if (placementPreviewImageEl) placementPreviewImageEl.style.display = 'none'; // Hide preview

             // Reset save button state
             if (savePlacementBtn) {
                 savePlacementBtn.disabled = false;
                 savePlacementBtn.textContent = 'Guardar Ubicación (en la Cruz)';
             }
             // Refresh selection list immediately
             populatePlacementPanel();
             console.log("Placement cancelled/returned to selection.");
         }

        /**
         * Saves the new POI data (from the form and map center) to Firestore.
         */
         async function handleSavePlacement() {
             // Ensure placement mode is active and necessary variables are set
             if (!isPlacingModel || !map || !poiCollectionRef || !savePlacementBtn || !currentPlacingModel.url) {
                 console.error("Save placement called in invalid state");
                 // Reset button if error occurs early
                 if (savePlacementBtn) {
                     savePlacementBtn.disabled = false;
                     savePlacementBtn.textContent = 'Guardar Ubicación (en la Cruz)';
                 }
                 return;
             }

             const latlng = map.getCenter(); // Get coordinates from map center
             showMessage('Guardando...', 2000);
             // Disable button during save
             savePlacementBtn.disabled = true;
             savePlacementBtn.textContent = 'Guardando...';

             let newPoi = {};
             try {
                 // Read values from form
                 const poiType = placePoiTypeSelect.value;
                 let modelUrl = '';
                 let videoUrl = '';
                 let name = placeNameInput.value.trim();

                 // Validate name
                 if (!name) throw new Error("El nombre descriptivo es obligatorio.");

                 // Set URL based on POI type
                 if (poiType === 'video') {
                     videoUrl = placeVideoUrlInput.value.trim();
                     if (!videoUrl) throw new Error("La URL del video es obligatoria para el tipo Video.");
                     // Basic URL format warning (doesn't guarantee validity)
                     if (!videoUrl.startsWith('http') || !videoUrl.toLowerCase().endsWith('.mp4')) {
                         console.warn("El formato de la URL del video podría ser inválido:", videoUrl);
                     }
                     modelUrl = ''; // Ensure model URL is empty for video POIs
                  } else { // 'model' type
                     modelUrl = currentPlacingModel.url; // Use URL from the selected item
                     if (!modelUrl) throw new Error("Falta la URL del modelo (error interno)."); // Should not happen
                     videoUrl = ''; // Ensure video URL is empty for model POIs
                  }

                 // Construct POI data object
                 newPoi = {
                     name: name,
                     poiType: poiType,
                     modelUrl: modelUrl,
                     videoUrl: videoUrl,
                     soundUrl: placeSoundUrlInput?.value.trim() || "",
                     lat: latlng.lat,
                     lon: latlng.lng,
                     scale: parseFloat(placeScaleInput?.value || "1.0"), // Base scale
                     groundHeight: parseFloat(placeHeightInput?.value || "0.0"),
                     startDate: placeStartDateInput?.value || "",
                     endDate: placeEndDateInput?.value || "",
                     arScaleMultiplier: 1.0 // Default visual scale multiplier
                 };

                 // Basic validations
                 if (isNaN(newPoi.scale) || isNaN(newPoi.groundHeight)) throw new Error("La Escala Base y Altura deben ser números válidos.");
                 if (newPoi.scale <= 0) throw new Error("La Escala Base debe ser positiva.");
                 if (!newPoi.startDate || !newPoi.endDate) throw new Error("Las fechas de Inicio y Fin son obligatorias.");
                 const startDate = new Date(newPoi.startDate);
                 const endDate = new Date(newPoi.endDate);
                 if (isNaN(startDate.getTime()) || isNaN(endDate.getTime())) throw new Error("Formato de fecha inválido.");
                 if (endDate < startDate) throw new Error("La fecha de Fin no puede ser anterior a la de Inicio.");

                 // Add document to Firestore
                 const docRef = await addDoc(poiCollectionRef, newPoi);
                 console.log("POI saved with ID:", docRef.id);

                 showMessage(`'${newPoi.name}' guardado exitosamente!`, 3000);
                 cancelPlacement(); // Exit placement mode on success

             } catch (error) {
                 console.error("Error saving POI: ", error);
                 showMessage("Error al guardar: " + error.message, 5000);
                 // Re-enable button on error
                 if (savePlacementBtn) {
                     savePlacementBtn.disabled = false;
                     savePlacementBtn.textContent = 'Guardar Ubicación (en la Cruz)';
                 }
             }
         }

        /**
         * Handles clicks on the delete button within the placed POIs list on the map page.
         * Implements a confirmation step.
         */
         async function handleDeletePoiOnMap(e) {
             // Check if the clicked element is a delete button
             if (e.target && e.target.classList.contains('delete-btn-map')) {
                 const docId = e.target.getAttribute('data-id');
                 const button = e.target;
                 if (!docId || button.disabled) return; // Ignore if no ID or button disabled

                 // First click: Ask for confirmation
                 if (!button.classList.contains('confirm')) {
                     button.textContent = '¿Seguro?';
                     button.classList.add('confirm');
                     // Set timeout to revert button state if not clicked again
                     setTimeout(() => {
                         // Find the button again in case the list was re-rendered
                         const currentButton = placedPoisList?.querySelector(`.delete-btn-map[data-id="${docId}"]`);
                         if (currentButton && currentButton.classList.contains('confirm')) {
                              currentButton.textContent = 'Eliminar';
                             currentButton.classList.remove('confirm');
                         }
                     }, 3000); // 3-second confirmation window
                     return;
                 }

                 // Second click (confirmation): Proceed with deletion
                 if (!firebaseReady || !poiCollectionRef) {
                      showMessage("Error: La base de datos no está lista para eliminar.", 4000);
                     // Reset button state
                     button.textContent = 'Eliminar';
                      button.classList.remove('confirm');
                      return;
                 }

                 try {
                     // Disable button during deletion
                     button.disabled = true;
                     button.textContent = '...';
                     // Delete document from Firestore
                     const docRef = doc(db, poiCollectionRef.path, docId);
                     await deleteDoc(docRef);
                     showMessage('Punto de interés eliminado.', 3000);
                     // No need to reset button, it will be removed by the snapshot listener
                 } catch (error) {
                     console.error("Error deleting document from map page: ", error);
                     showMessage("No se pudo eliminar el documento: " + error.message, 5000);
                     // Re-enable button on error
                     const currentButton = placedPoisList?.querySelector(`.delete-btn-map[data-id="${docId}"]`);
                     if (currentButton) {
                         currentButton.disabled = false;
                         currentButton.textContent = 'Eliminar';
                         currentButton.classList.remove('confirm');
                     }
                 }
             }
         }

        // --- Summary Page Logic ---

        /**
         * Populates the summary page with a list of configured POIs, indicating their active status.
         */
        function populateSummaryPage() {
             // Ensure UI elements are ready
             if (!summaryPoiList || !loadingSummaryPois) {
                 console.error("Summary page elements not found.");
                 return;
             }
             loadingSummaryPois.style.display = 'block'; // Show loading indicator
             summaryPoiList.innerHTML = ''; // Clear previous list

             // Check Firebase status
             if (!firebaseReady) {
                 loadingSummaryPois.textContent = "Error: No conectado a Firebase.";
                 return;
             }
             // Check if there is any POI data
             if (allPoisData.length === 0) {
                 loadingSummaryPois.style.display = 'none'; // Hide loading indicator
                 summaryPoiList.innerHTML = '<p class="text-gray-500">No hay contenido configurado para mostrar en AR.</p>';
                 return;
             }

             loadingSummaryPois.style.display = 'none'; // Hide loading indicator
             const now = new Date(); // Current date/time for status check
             let activePoisCount = 0; // Counter for active POIs

             // Iterate through all POI data
             allPoisData.forEach(poi => {
                 const isModel = poi.poiType === 'model';
                 // Parse start/end dates (handle invalid/missing dates)
                 const startDate = poi.startDate ? new Date(poi.startDate + "T00:00:00Z") : null; // Assume UTC midnight start
                 const endDate = poi.endDate ? new Date(poi.endDate + "T23:59:59Z") : null;     // Assume UTC end of day

                 // Determine if the POI is currently active based on dates
                 let isActive = false;
                 if (startDate && endDate) {
                     isActive = now >= startDate && now <= endDate;
                 } else if (startDate) { // Only start date set
                     isActive = now >= startDate;
                 } else { // No dates set, assume always active (or handle based on requirements)
                     isActive = true; // Default to true if no dates
                 }

                 if (isActive) activePoisCount++; // Increment active counter

                 // Create list item element
                 const poiElement = document.createElement('div');
                 poiElement.className = `p-4 border rounded-lg shadow-sm ${isActive ? 'bg-green-50' : 'bg-gray-50 opacity-60'}`; // Different style for active/inactive

                 // Get preview image URL
                 let imageUrl = '';
                 if(isModel && poi.modelUrl) {
                     const ecoModel = ECOPIENSA_MODELS.find(m => m.modelUrl === poi.modelUrl);
                     if (ecoModel) imageUrl = ecoModel.imageUrl;
                 } else if (!isModel) { // Video
                     imageUrl = CUSTOM_VIDEO_PLACEHOLDER.imageUrl;
                 }

                 // Populate list item HTML
                 poiElement.innerHTML = `
                     <div class="flex items-start space-x-4">
                         ${imageUrl ? `<img src="${imageUrl}" alt="Preview" class="w-16 h-16 rounded object-contain border bg-white" onerror="this.style.display='none'">` : '<div class="w-16 h-16 rounded bg-gray-200 flex items-center justify-center text-xs text-gray-500">No Img</div>'}
                         <div class="flex-1">
                             <div class="flex justify-between items-center mb-1">
                                 <strong class="text-lg text-gray-800">${poi.name || 'Sin Nombre'}</strong>
                                 <span class="text-xs font-semibold px-2 py-0.5 rounded-full ${isActive ? 'bg-green-200 text-green-800' : 'bg-gray-200 text-gray-700'}">
                                     ${isActive ? 'ACTIVO' : 'INACTIVO'}
                                 </span>
                             </div>
                             <span class="block text-sm ${isModel ? 'text-blue-600' : 'text-purple-600'}">${isModel ? 'Modelo 3D' : 'Video'}</span>
                             <div class="text-xs text-gray-500 mt-2">
                                 <span>Lat: ${poi.lat?.toFixed(5) || 'N/A'}</span> |
                                 <span>Lon: ${poi.lon?.toFixed(5) || 'N/A'}</span> |
                                 <span>Escala Base: ${poi.scale?.toFixed(1) || 'N/A'}</span> | <span>Escala AR: ${poi.arScaleMultiplier?.toFixed(1) || '1.0'}x</span> </div>
                             <div class="text-xs text-gray-500 mt-1">
                                 <span>Inicio: ${poi.startDate || 'N/A'}</span> |
                                 <span>Fin: ${poi.endDate || 'N/A'}</span>
                             </div>
                         </div>
                     </div>
                 `;
                 summaryPoiList.appendChild(poiElement);
             });

             // Add note if there are configured POIs but none are active
             if (activePoisCount === 0 && allPoisData.length > 0) {
                 const info = document.createElement('p');
                 info.className = "text-center text-amber-700 font-semibold mt-4";
                 info.textContent = "Nota: Hay contenido configurado, pero ninguno está activo para la fecha de hoy.";
                 summaryPoiList.prepend(info); // Add message at the top
             }
         }

        // --- AR Flow Functions (A-Frame, AR.js) ---

        /**
         * Starts the entire Augmented Reality experience flow:
         * 1. Requests permissions (Camera, GPS High Accuracy).
         * 2. Loads necessary AR assets (models, videos, sounds).
         * 3. Initializes the A-Frame scene with POIs.
         * 4. Hides loading screen.
         */
        async function startARFlow() {
            console.log("Starting AR Flow...");
            // Ensure UI elements are ready
            if (!arLoadingScreen || !permissionModal || !loadingStatusText) {
                console.error("AR UI elements not found.");
                return;
            }

            arLoadingScreen.classList.add('active'); // Show loading screen
            updateARProgressBar('start'); // Initial progress state

            // Reset AR scale multiplier and UI to default (1.0x)
            arFineScaleMultiplier = 1.0;
            if (arScaleSlider) arScaleSlider.value = arFineScaleMultiplier;
            if (arScaleValueDisplay) arScaleValueDisplay.textContent = `${arFineScaleMultiplier.toFixed(2)}x`;
            closestPoiIdForScaling = null; // Reset nearest POI for scaling
            if (saveArScaleBtn) saveArScaleBtn.disabled = true; // Disable save button initially

            // 1. Request Permissions (Camera and GPS High Accuracy)
            try {
                // Request Camera permission
                loadingStatusText.textContent = "Verificando permisos de cámara...";
                const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
                stream.getTracks().forEach(track => track.stop()); // Stop stream immediately after getting permission

                // Request GPS High Accuracy permission
                loadingStatusText.textContent = "Verificando permisos de ubicación (Alta Precisión)...";
                await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(
                        (pos) => {
                            // Store initial position
                            lastKnownGps = { latitude: pos.coords.latitude, longitude: pos.coords.longitude, accuracy: pos.coords.accuracy, heading: pos.coords.heading };
                            console.log("GPS permission granted, initial position:", pos.coords);
                            resolve(pos);
                        },
                        (err) => {
                            console.error("GPS permission error:", err.message, "Code:", err.code);
                            let errorMsg = "Permiso de GPS denegado o no disponible.";
                            if (err.code === 1) errorMsg = "Permiso de GPS denegado.";
                            if (err.code === 2) errorMsg = "Señal de GPS no disponible.";
                            if (err.code === 3) errorMsg = "Señal de GPS (Alta Precisión) tardó demasiado (60s).";
                            reject(new Error(errorMsg)); // Reject promise with error message
                        },
                        {
                            enableHighAccuracy: true, // Request high accuracy
                            timeout: 60000,       // 60-second timeout
                            maximumAge: 0         // Force fresh reading
                        }
                    );
                });

                updateARProgressBar('permissions'); // Update progress after getting permissions

                // (NUEVO) Mostrar el panel de ubicación real después de obtener permisos
                if (arRealtimeLocationEl) {
                    arRealtimeLocationEl.style.display = 'block';
                }

            } catch (err) {
                // Handle permission errors
                console.error("AR Permission Error:", err);
                arLoadingScreen.classList.remove('active'); // Hide loading screen
                permissionModal.style.display = 'flex'; // Show permission modal again
                let msg = err.message || "Error de permisos AR. Inténtalo de nuevo.";
                // Provide specific message if denied
                 if (err.message.includes("denied")) {
                      msg = "Acceso a cámara o ubicación denegado. Habilítalos en la configuración del navegador.";
                 }
                showMessage(msg, 6000);
                return; // Stop AR flow
            }

            // 2. Filter Active POIs and Count Assets
            const activePois = allPoisData.filter(poi => {
                const now = new Date();
                const startDate = poi.startDate ? new Date(poi.startDate + "T00:00:00Z") : null;
                const endDate = poi.endDate ? new Date(poi.endDate + "T23:59:59Z") : null;
                let isActive = true; // Default to active if no dates
                if (startDate && endDate) { isActive = now >= startDate && now <= endDate; }
                else if (startDate) { isActive = now >= startDate; }
                return isActive && poi.lat != null && poi.lon != null; // Must be active AND have coordinates
            });

            // Handle case where no active POIs are found
            if (activePois.length === 0) {
                loadingStatusText.textContent = "No hay contenido activo con coordenadas para hoy.";
                setTimeout(() => arLoadingScreen.classList.remove('active'), 2500);
                showMessage("No hay contenido activo con coordenadas configurado para la fecha de hoy.", 5000);
                return; // Stop AR flow
            }

            // Count total assets to load for progress bar calculation
            totalARAssetsToLoad = 0;
            activePois.forEach(poi => {
                 if (poi.poiType === 'model' && poi.modelUrl) totalARAssetsToLoad++;
                 if (poi.poiType === 'video' && poi.videoUrl) totalARAssetsToLoad++; // Count video URLs if needed later
                 if (poi.soundUrl) totalARAssetsToLoad++;
            });

            // 3. Initialize Scene and Load Assets
            try {
                if (totalARAssetsToLoad > 0) {
                    updateARProgressBar('load_assets_start');
                    await initializeARScene(activePois); // Initialize A-Frame scene structure
                    await loadARResources(); // Wait for A-Frame to load assets defined in <a-assets>
                } else {
                    loadingAssetStatus.textContent = "No hay recursos que descargar.";
                    await initializeARScene(activePois); // Initialize scene even without assets
                }
            } catch (sceneOrAssetError) {
                console.error("Error during AR Scene/Asset initialization:", sceneOrAssetError);
                arLoadingScreen.classList.remove('active');
                showMessage("Error al preparar la escena AR. Verifica la consola.", 5000);
                return; // Stop AR flow
            }


            // 4. Final Setup and Hide Loading
            updateARProgressBar('scene_setup');
            // GPS listeners are attached in initializeARScene, gps-camera component starts automatically

            // 5. Complete Loading Sequence
            setTimeout(() => {
                updateARProgressBar('gps_active'); // Indicate waiting for GPS lock (even though listeners are active)
                setTimeout(() => {
                    updateARProgressBar('complete'); // Mark as complete
                    setTimeout(() => {
                        arLoadingScreen.classList.remove('active'); // Hide loading screen
                        showMessage("AR Iniciada. Esperando señal GPS estable...");
                    }, 500); // Short delay before hiding
                }, 1000); // Give GPS a moment
            }, 500); // Short delay after scene setup
        }

        /**
         * Returns a Promise that resolves when all assets defined in <a-assets>
         * have been loaded by A-Frame.
         */
        function loadARResources() {
            return new Promise((resolve, reject) => {
                 // Immediately resolve if no assets need loading
                 if (totalARAssetsToLoad === 0) {
                     resolve();
                     return;
                 }

                 const assetsEl = arScene?.querySelector('a-assets');
                 if (!assetsEl) {
                     console.error('A-Assets element not found during resource loading.');
                     return reject(new Error('A-Assets element not found.'));
                 }

                 let loadedCount = 0;
                 const assetLoadTimeout = 90000; // 90 seconds timeout for all assets

                 // Listener for individual asset loading success
                 const itemLoadedListener = (e) => {
                     const assetId = e.detail?.id || e.detail?.item?.id || 'unknown asset';
                     console.log(`Asset loaded: ${assetId}`);
                     loadedCount++;
                     updateARProgressBar('asset_loaded', assetId);

                     if (loadedCount === totalARAssetsToLoad) {
                         cleanupListeners();
                         resolve(); // All assets loaded
                     }
                 };

                 // Listener for individual asset loading error
                 const itemErrorListener = (e) => {
                     const assetId = e.detail?.id || e.detail?.item?.id || 'unknown asset';
                     const errorSrc = e.detail?.src || e.detail?.item?.src || 'unknown source';
                     console.error(`Error loading asset: ${assetId} from ${errorSrc}`, e.detail);
                     // Optionally, count error as "loaded" to prevent blocking, or reject
                     loadedCount++; // Count error to potentially continue
                     updateARProgressBar('asset_loaded', `${assetId} (Error)`);
                     showMessage(`Error cargando ${assetId}. Puede que no se muestre.`, 4000);
                     if (loadedCount === totalARAssetsToLoad) {
                         cleanupListeners();
                         resolve(); // Resolve even with errors for now
                         // reject(new Error(`Failed to load asset: ${assetId}`)); // Alternative: Fail completely
                     }
                 };

                 // Listener for overall assets timeout
                 const assetsTimeoutListener = () => {
                     console.error("Timeout loading assets in <a-assets>.");
                     cleanupListeners();
                     reject(new Error(`Timeout (${assetLoadTimeout/1000}s) waiting for AR assets to load.`));
                 };

                 // Listener for when A-Frame considers all assets loaded (fallback)
                 const assetsLoadedListener = () => {
                     console.log("A-Frame reported <a-assets> loaded.");
                     // If our counter didn't reach the total, log warning but resolve anyway
                     if (loadedCount < totalARAssetsToLoad) {
                         console.warn(`A-Frame loaded event fired, but only ${loadedCount}/${totalARAssetsToLoad} assets were tracked individually.`);
                         // Force update progress bar to near complete if needed
                         while(loadedCount < totalARAssetsToLoad){
                             loadedCount++;
                             updateARProgressBar('asset_loaded', 'Forzado por evento LOADED');
                         }
                     }
                     cleanupListeners();
                     resolve();
                 };

                 // Cleanup function to remove listeners
                 const cleanupListeners = () => {
                     assetsEl.removeEventListener('loaded', assetsLoadedListener);
                     assetsEl.removeEventListener('timeout', assetsTimeoutListener);
                     // A-Frame has different event names for items, listen to both common ones
                     assetsEl.removeEventListener('asset-item-loaded', itemLoadedListener); // Older?
                     assetsEl.removeEventListener('child-loaded', itemLoadedListener);     // Newer?
                     assetsEl.removeEventListener('asset-item-error', itemErrorListener);  // Error events
                     assetsEl.removeEventListener('child-error', itemErrorListener);       // Error events
                     clearTimeout(overallTimeoutId);
                 };

                 // Attach listeners
                 assetsEl.addEventListener('loaded', assetsLoadedListener);
                 assetsEl.addEventListener('timeout', assetsTimeoutListener);
                 assetsEl.addEventListener('asset-item-loaded', itemLoadedListener);
                 assetsEl.addEventListener('child-loaded', itemLoadedListener);
                 assetsEl.addEventListener('asset-item-error', itemErrorListener);
                 assetsEl.addEventListener('child-error', itemErrorListener);

                 // Set an overall timeout as a safety net
                 const overallTimeoutId = setTimeout(() => {
                     if (loadedCount < totalARAssetsToLoad) {
                         assetsTimeoutListener(); // Trigger timeout logic if not all loaded
                     }
                 }, assetLoadTimeout);
             });
        }


        /**
         * Initializes the A-Frame scene, camera, lights, and injects POI entities.
         * Also attaches GPS event listeners to the camera.
         */
        async function initializeARScene(activePois) {
            const arSceneContainer = document.getElementById('ar-scene-container');
            if (!arSceneContainer) {
                console.error("AR container (#ar-scene-container) not found!");
                return Promise.reject(new Error("AR container not found."));
            }
            arSceneContainer.innerHTML = ''; // Clear previous scene if any

            // (SOLUCIÓN GPS 1/1)
            // MODIFICADO: Se eliminaron 'simulateLatitude' y 'simulateLongitude'
            // para forzar el uso del GPS real del dispositivo.
            //
            // (MEJORA) Atributos de gps-camera actualizados
            // Se usa 'gpsTimeInterval' (actualización más frecuente)
            // Se usa 'gpsMinAccuracy' (permite precisiones menos ideales para que funcione)
            const sceneHTML = `
                <a-scene
                    id="ar-scene"
                    embedded
                    vr-mode-ui="enabled: false"
                    renderer="logarithmicDepthBuffer: true; antialias: true; precision: high; alpha: true;"
                    style="background: transparent;"
                    arjs="sourceType: webcam; videoTexture: true; debugUIEnabled: false;">

                    <a-assets timeout="60000"></a-assets>

                    <a-camera
                        id="ar-camera"
                        gps-camera="
                            gpsMinDistance: 1;
                            gpsMaxDistance: 1000;
                            gpsTimeInterval: 3000;
                            gpsMinAccuracy: 100;
                        "
                        look-controls="enabled: false"
                        rotation-reader>
                    </a-camera>

                </a-scene>
            `;

            try {
                // Inject the scene HTML
                arSceneContainer.innerHTML = sceneHTML;
                arScene = document.querySelector('#ar-scene');
                if (!arScene) throw new Error("a-scene element not found after injection.");

                const assets = arScene.querySelector('a-assets');
                if (!assets) throw new Error("a-assets element not found after injection.");

                // Create and add A-Frame entities for each active POI
                activePois.forEach((poi) => {
                    try { // Add try-catch around each entity creation
                        const entityId = `entity-${poi.id}`;
                        const baseScale = poi.scale || 1.0; // Scale defined in admin panel (meters for model bounding box, width for video)
                        const savedMultiplier = poi.arScaleMultiplier || 1.0; // Multiplier saved from AR view, default 1.0
                        const initialVisualScale = baseScale * savedMultiplier; // Combined initial scale
                        const groundHeight = poi.groundHeight || 0; // Height offset

                        const entity = document.createElement('a-entity');
                        entity.setAttribute('id', entityId);
                        entity.setAttribute('class', 'poi-entity'); // For global scale adjustments
                        entity.setAttribute('data-poi-id', poi.id); // Store POI ID for reference
                        entity.setAttribute('data-name', poi.name); // Store POI name
                        entity.setAttribute('gps-entity-place', `latitude: ${poi.lat}; longitude: ${poi.lon};`); // Set GPS coordinates
                        entity.setAttribute('position', `0 ${groundHeight} 0`); // Set initial height offset
                        // Apply combined initial scale (base * saved multiplier)
                        entity.setAttribute('scale', `${initialVisualScale} ${initialVisualScale} ${initialVisualScale}`);

                        // Add Model asset and entity
                        if (poi.poiType === 'model' && poi.modelUrl) {
                            const assetId = `model-${poi.id}`;
                            const modelAsset = document.createElement('a-asset-item');
                            modelAsset.setAttribute('id', assetId);
                            modelAsset.setAttribute('src', poi.modelUrl);
                            assets.appendChild(modelAsset); // Add to <a-assets>

                            const modelEntity = document.createElement('a-gltf-model');
                            modelEntity.setAttribute('src', `#${assetId}`); // Reference asset
                            modelEntity.setAttribute('animation-mixer', ''); // Enable animations if present
                            entity.appendChild(modelEntity);
                        }

                        // Add Video asset and entity
                        else if (poi.poiType === 'video' && poi.videoUrl) {
                            const videoId = `video-${poi.id}`;
                            const videoAsset = document.createElement('video');
                            videoAsset.setAttribute('id', videoId);
                            videoAsset.setAttribute('src', poi.videoUrl);
                            videoAsset.setAttribute('crossorigin', 'anonymous');
                            videoAsset.setAttribute('preload', 'auto');
                            videoAsset.setAttribute('loop', 'true');
                            videoAsset.setAttribute('autoplay', 'true'); // Autoplay muted
                            videoAsset.setAttribute('playsinline', 'true');
                            videoAsset.setAttribute('webkit-playsinline', 'true');
                            videoAsset.setAttribute('muted', 'true'); // Must be muted
                            assets.appendChild(videoAsset); // Add to <a-assets>

                            const videoWidth = poi.scale || 2.0; // Use 'scale' as video width in meters, default 2m
                            const videoHeight = (9 / 16) * videoWidth; // Assume 16:9 aspect ratio

                            const videoEntity = document.createElement('a-video');
                            videoEntity.setAttribute('src', `#${videoId}`); // Reference asset
                            videoEntity.setAttribute('width', videoWidth.toFixed(2));
                            videoEntity.setAttribute('height', videoHeight.toFixed(2));
                            // Position video centered vertically based on its height
                            videoEntity.setAttribute('position', `0 ${(videoHeight / 2).toFixed(2)} 0`);
                            // Apply the saved AR scale multiplier specifically to the video element
                            videoEntity.setAttribute('scale', `${savedMultiplier} ${savedMultiplier} ${savedMultiplier}`);

                            // Add click listener to toggle mute/unmute
                            videoEntity.addEventListener('click', () => {
                                if (videoAsset.muted) {
                                    videoAsset.muted = false; videoAsset.play(); // Unmute and ensure play
                                    showMessage(`Sonido activado para: ${poi.name}`, 2000);
                                } else {
                                    videoAsset.muted = true; // Mute again
                                    showMessage(`Sonido desactivado para: ${poi.name}`, 2000);
                                }
                            });

                            entity.appendChild(videoEntity);
                            // Remove the main entity's scale for videos, as it's handled by a-video width/height + multiplier
                             entity.removeAttribute('scale');
                        }

                        // Add Background Sound asset and component
                        if (poi.soundUrl) {
                            const soundId = `sound-${poi.id}`;
                            const soundAsset = document.createElement('audio');
                            soundAsset.setAttribute('id', soundId);
                            soundAsset.setAttribute('src', poi.soundUrl);
                            soundAsset.setAttribute('crossorigin', 'anonymous');
                            soundAsset.setAttribute('preload', 'auto');
                            soundAsset.setAttribute('loop', 'true');
                            assets.appendChild(soundAsset); // Add to <a-assets>
                            // Attach sound component to the main entity
                            entity.setAttribute('sound', `src: #${soundId}; autoplay: true; volume: 0.5`);
                        }

                        arScene.appendChild(entity); // Add the complete POI entity to the scene
                    } catch (entityError) {
                        // Log errors creating individual entities but continue with others
                        console.error(`Error creating entity for POI ${poi.id} (${poi.name}):`, entityError);
                        showMessage(`Error al crear '${poi.name}'. Verifica la consola.`);
                    }
                }); // End forEach POI

                // Add standard lighting to the scene
                const ambientLight = document.createElement('a-light');
                ambientLight.setAttribute('type', 'ambient');
                ambientLight.setAttribute('color', '#BBB');
                arScene.appendChild(ambientLight);

                const directionalLight = document.createElement('a-light');
                directionalLight.setAttribute('type', 'directional');
                directionalLight.setAttribute('color', '#FFF');
                directionalLight.setAttribute('intensity', '0.6'); // Slightly less intense directional
                directionalLight.setAttribute('position', '-1 1 0.5'); // Adjust light direction
                arScene.appendChild(directionalLight);

                // Attach GPS event listeners to the camera
                const camera = arScene.querySelector('a-camera');
                if (camera) {
                    console.log("Attaching GPS event listeners to A-Frame camera...");
                    camera.removeEventListener('gps-camera-update-position', onGPSUpdate); // Remove old listeners first
                    camera.removeEventListener('gps-camera-error', onGPSError);
                    camera.addEventListener('gps-camera-update-position', onGPSUpdate);
                    camera.addEventListener('gps-camera-error', onGPSError);
                } else {
                    console.error("Could not find A-Frame camera to attach listeners.");
                    throw new Error("A-Frame camera not found."); // Make it a fatal error for scene init
                }

                console.log("AR scene structure created with POIs and listeners.");
                return Promise.resolve(); // Indicate successful scene initialization

            } catch (sceneError) {
                // Handle fatal errors during scene initialization
                console.error("Fatal error initializing AR scene:", sceneError);
                showMessage("Error crítico al crear la escena AR. Verifica la consola.", 6000);
                return Promise.reject(sceneError); // Indicate failure
            }
        }

        /**
         * Applies the current visual scale multiplier (from the slider) to all POI entities.
         */
        function applyFineScaleAdjustment() {
            if (!arScene) return; // Exit if scene isn't ready
            arFineScaleMultiplier = parseFloat(arScaleSlider.value); // Update global multiplier from slider
            arScaleValueDisplay.textContent = `${arFineScaleMultiplier.toFixed(2)}x`; // Update UI display

            const poiEntities = arScene.querySelectorAll('.poi-entity');

            poiEntities.forEach(entity => {
                const poiId = entity.dataset.poiId;
                const poiData = poiDataMap.get(poiId);
                if (!poiData) return; // Skip if POI data not found

                const baseScale = poiData.scale || 1.0; // Get the base scale defined in admin panel
                // Calculate the final visual scale: base * current slider multiplier
                const visualScale = baseScale * arFineScaleMultiplier;

                // Apply scale differently for models vs. videos
                const videoEntity = entity.querySelector('a-video');
                if (videoEntity) {
                    // For videos, apply ONLY the slider multiplier to the a-video element
                    videoEntity.setAttribute('scale', `${arFineScaleMultiplier} ${arFineScaleMultiplier} ${arFineScaleMultiplier}`);
                } else {
                    // For models, apply the combined visual scale to the main a-entity
                    entity.setAttribute('scale', `${visualScale} ${visualScale} ${visualScale}`);
                }
            });

            // Enable the "Save Scale" button only if a POI is close enough
            if (saveArScaleBtn) saveArScaleBtn.disabled = !closestPoiIdForScaling;
        }

        /**
         * Saves the current AR scale multiplier (from the slider) to the nearest POI in Firebase.
         */
        async function handleSaveARScale() {
            // Validate state: ensure a POI is selected, Firebase is ready, and button exists
            if (!closestPoiIdForScaling || !firebaseReady || !poiCollectionRef || !saveArScaleBtn) {
                showMessage("No hay un POI cercano seleccionado para guardar la escala.", 3000);
                return;
            }
            if (!arScaleSlider) { // Ensure slider exists
                 console.error("Slider de escala AR no encontrado.");
                 return;
            }

            const newMultiplier = parseFloat(arScaleSlider.value); // Get value from slider
            const poiToUpdate = poiDataMap.get(closestPoiIdForScaling); // Get data of the POI to update

            if (!poiToUpdate) { // Should not happen if button is enabled
                showMessage("Error: No se encontraron datos del POI cercano.", 3000);
                return;
            }

            showMessage(`Guardando escala ${newMultiplier.toFixed(2)}x para '${poiToUpdate.name}'...`, 2000);
            // Disable button during save
            saveArScaleBtn.disabled = true;
            saveArScaleBtn.textContent = 'Guardando...';

            try {
                // Update the specific field in Firestore
                const docRef = doc(db, poiCollectionRef.path, closestPoiIdForScaling);
                await updateDoc(docRef, { arScaleMultiplier: newMultiplier });
                showMessage(`Escala ${newMultiplier.toFixed(2)}x guardada para '${poiToUpdate.name}'!`, 3000);

                // Update local data immediately for consistency
                poiToUpdate.arScaleMultiplier = newMultiplier;
                poiDataMap.set(closestPoiIdForScaling, poiToUpdate);

            } catch (error) {
                console.error("Error updating AR scale multiplier in Firebase:", error);
                showMessage("Error al guardar la escala en Firebase: " + error.message, 5000);
            } finally {
                // Re-enable button (state might have changed, re-check if POI is still closest)
                if (saveArScaleBtn) {
                    saveArScaleBtn.disabled = !closestPoiIdForScaling; // Re-enable only if still closest
                    saveArScaleBtn.textContent = 'Guardar Escala (para POI más cercano)';
                }
            }
        }

        /**
         * Cleans up the AR scene, removes listeners, and stops GPS tracking.
         */
        function stopAR() {
            if (arScene) {
                try {
                    // Remove GPS listeners from camera FIRST
                    const camera = arScene.querySelector('a-camera');
                    if (camera) {
                         console.log("Removing GPS event listeners from A-Frame camera...");
                        camera.removeEventListener('gps-camera-update-position', onGPSUpdate);
                        camera.removeEventListener('gps-camera-error', onGPSError);
                    } else {
                         console.warn("Could not find camera to remove listeners during stopAR.");
                    }

                    arScene.pause(); // Pause A-Frame processing

                    // Stop and clear media elements
                    arScene.querySelectorAll('video, audio').forEach(media => {
                        try {
                            media.pause();
                            media.src = ''; // Clear source
                            media.removeAttribute('src');
                            media.load();
                        } catch (mediaError) { console.warn("Error stopping media:", mediaError); }
                    });

                    // Force remove AR.js background video element
                    const arVideo = document.querySelector('.arjs-video');
                    if (arVideo) {
                        try {
                            arVideo.pause();
                            if(arVideo.srcObject) { // Stop camera track
                                 arVideo.srcObject.getTracks().forEach(track => track.stop());
                            }
                            arVideo.srcObject = null;
                            arVideo.removeAttribute('src');
                            arVideo.remove(); // Remove from DOM
                            console.log("AR.js video element stopped and removed.");
                        } catch (videoError) { console.warn("Error removing AR video:", videoError); }
                    }
                } catch (e) {
                     console.warn("Error during AR scene cleanup:", e);
                }

                // Remove the scene from the DOM
                const arContainer = document.getElementById('ar-scene-container');
                if (arContainer) arContainer.innerHTML = '';

                arScene = null; // Clear scene reference
                console.log("AR Scene removed from DOM.");
            }
            // Hide loading screen if it was somehow stuck
            if (arLoadingScreen) arLoadingScreen.classList.remove('active');
            // Reset GPS info display
            const gpsStatusEl = document.getElementById('gps-status');
            const gpsAccuracyEl = document.getElementById('gps-accuracy');
            if (gpsStatusEl) gpsStatusEl.textContent = "Buscando...";
            if (gpsAccuracyEl) gpsAccuracyEl.textContent = "--";

            // Reset AR UI elements
            if (arGuide) arGuide.style.display = 'none'; // Hide guide
            // (NUEVO) Ocultar y resetear el panel de ubicación en tiempo real
            if (arRealtimeLocationEl) {
                arRealtimeLocationEl.style.display = 'none';
                if (realtimeLatEl) realtimeLatEl.textContent = "Lat: --.--";
                if (realtimeLonEl) realtimeLonEl.textContent = "Lon: --.--";
            }
            if (arScaleSlider) arScaleSlider.value = 1.0; // Reset visual slider
            if (saveArScaleBtn) saveArScaleBtn.disabled = true; // Disable save button
            closestPoiIdForScaling = null; // Reset closest POI ID

            console.log("AR Stopped.");
        }

        // --- AR UI Updates (Guidance, GPS Status) ---

        /**
         * Updates the AR guidance panel (distance, direction to nearest POI)
         * and manages the state for saving AR scale.
         */
        function updateARGuide() {
            let closestPoi = null;
            let minDistance = Infinity;

            // Filter active POIs with valid coordinates
            const now = new Date();
            const activePois = allPoisData.filter(poi => {
                if (!poi.lat || !poi.lon) return false; // Skip POIs without coordinates
                const startDate = poi.startDate ? new Date(poi.startDate + "T00:00:00Z") : null;
                const endDate = poi.endDate ? new Date(poi.endDate + "T23:59:59Z") : null;
                let isActive = true;
                if (startDate && endDate) { isActive = now >= startDate && now <= endDate; }
                else if (startDate) { isActive = now >= startDate; }
                return isActive;
            });

            // Find the closest active POI
            activePois.forEach(poi => {
                const distance = calculateDistance(lastKnownGps.latitude, lastKnownGps.longitude, poi.lat, poi.lon);
                if (distance < minDistance) {
                    minDistance = distance;
                    closestPoi = poi;
                }
            });

            // Update UI if a close POI is found and GPS accuracy is acceptable
            const MIN_GUIDE_ACCURACY = 150; // Show guide if accuracy is better than 150m
            if (closestPoi && lastKnownGps.accuracy < MIN_GUIDE_ACCURACY) {
                // Calculate bearing and difference
                const targetBearing = calculateBearing(lastKnownGps.latitude, lastKnownGps.longitude, closestPoi.lat, closestPoi.lon);
                const heading = lastKnownGps.heading ?? 0; // Use 0 if heading is null
                const bearingDiff = targetBearing - heading;

                // Update guide panel text
                guideName.textContent = closestPoi.name;
                guideDistance.textContent = `${minDistance.toFixed(1)}m`;
                guideBearing.textContent = getDirectionArrow(bearingDiff);
                arGuide.style.display = 'block'; // Show guide

                // Manage state for saving AR scale
                // If the closest POI changed OR was previously null
                if (closestPoiIdForScaling !== closestPoi.id) {
                     closestPoiIdForScaling = closestPoi.id; // Update the ID
                     const savedMultiplier = closestPoi.arScaleMultiplier || 1.0; // Get saved scale or default
                     // Update the slider and text display to match the saved scale for this POI
                     if (arScaleSlider) arScaleSlider.value = savedMultiplier;
                     if (arScaleValueDisplay) arScaleValueDisplay.textContent = `${savedMultiplier.toFixed(2)}x`;
                     // Apply this scale visually immediately
                     applyFineScaleAdjustment();
                }
                // Enable the save button now that a POI is selected
                if (saveArScaleBtn) saveArScaleBtn.disabled = false;

            } else {
                // Hide guide if no close POI or GPS is inaccurate
                arGuide.style.display = 'none';
                closestPoiIdForScaling = null; // Clear selected POI ID
                if (saveArScaleBtn) saveArScaleBtn.disabled = true; // Disable save button
            }
        }

        /**
         * Event handler for 'gps-camera-update-position' from A-Frame.
         * Updates global GPS state and UI elements.
         */
        function onGPSUpdate(event) {
            // Ignore events if AR page is not active (prevents updates after navigating away)
            if (!pages.ar?.classList.contains('active') || !arScene) return;

            // (CORRECCIÓN GPS)
            // La estructura del evento puede ser event.detail.coords O event.detail.position.coords
            // Se comprueban ambas para mayor robustez.
            const pos = event.detail.coords || event.detail.position?.coords;
            
            if (!pos) {
                console.warn("GPS update event missing position data.", event.detail);
                return;
            }
            const accuracy = pos.accuracy?.toFixed(2) ?? '??'; // Handle potentially missing accuracy

            // Update global GPS state
            lastKnownGps = {
                latitude: pos.latitude,
                longitude: pos.longitude,
                accuracy: pos.accuracy ?? 9999, // Use large number if accuracy missing
                heading: pos.heading // Can be null if device doesn't provide it
            };

            // Update GPS info panel UI
            const gpsStatusEl = document.getElementById('gps-status');
            const gpsAccuracyEl = document.getElementById('gps-accuracy');

            if (gpsStatusEl) gpsStatusEl.textContent = "OK";
            if (gpsAccuracyEl) {
                 gpsAccuracyEl.textContent = `${accuracy}`;
                 // Color code accuracy
                 if (lastKnownGps.accuracy > 50) gpsAccuracyEl.style.color = 'red';
                 else if (lastKnownGps.accuracy > 25) gpsAccuracyEl.style.color = 'orange';
                 else gpsAccuracyEl.style.color = 'lime';
            }

            // (NUEVO) Actualizar panel de ubicación en tiempo real
            if (realtimeLatEl) {
                 realtimeLatEl.textContent = `Lat: ${lastKnownGps.latitude.toFixed(6)}`;
            }
            if (realtimeLonEl) {
                 realtimeLonEl.textContent = `Lon: ${lastKnownGps.longitude.toFixed(6)}`;
            }

            // Update the AR guidance panel (which handles scale button state)
            updateARGuide();
        }

        /**
         * Event handler for 'gps-camera-error' from A-Frame.
         * Updates UI to show GPS error state.
         */
        function onGPSError(event) {
            // Ignore events if AR page is not active
            if (!pages.ar?.classList.contains('active') || !arScene) return;

            console.error("GPS Error (from A-Frame gps-camera):", event.detail);
            // Update GPS info panel UI
            const gpsStatusEl = document.getElementById('gps-status');
            if (gpsStatusEl) gpsStatusEl.textContent = "Error";
            const gpsAccuracyEl = document.getElementById('gps-accuracy');
            if (gpsAccuracyEl) {
                 gpsAccuracyEl.textContent = "N/A";
                 gpsAccuracyEl.style.color = 'red';
            }

            // (NUEVO) Actualizar panel de ubicación en tiempo real
            if (realtimeLatEl) {
                 realtimeLatEl.textContent = "Lat: Error";
            }
            if (realtimeLonEl) {
                 realtimeLonEl.textContent = "Lon: Error";
            }

            // Determine error message based on code
            let errorMsg = "Error de GPS.";
            const code = event.detail?.code; // Get error code from event detail
            if (code === 1) errorMsg = "Permiso de GPS denegado.";
            else if (code === 2) errorMsg = "Señal de GPS perdida.";
            else if (code === 3) errorMsg = "GPS tardó demasiado en responder.";
            showMessage(errorMsg, 4000);

             // Reset scale saving state on GPS error
             closestPoiIdForScaling = null;
             if (saveArScaleBtn) saveArScaleBtn.disabled = true;
        }

        /**
         * (NUEVO) Captura una imagen combinada del video AR y la escena A-Frame.
         */
        function handleScreenshot() {
            if (!arScene || !screenshotCanvas) {
                showMessage("Error: No se puede tomar la captura.", 2000);
                return;
            }

            const video = document.querySelector('.arjs-video');
            const aframeCanvas = arScene.canvas; // El canvas de A-Frame

            if (!video || !aframeCanvas) {
                showMessage("Error: No se encontraron los elementos de video o canvas.", 2000);
                return;
            }

            const ctx = screenshotCanvas.getContext('2d');
            
            // Establecer el tamaño del canvas temporal al tamaño del video
            const w = video.videoWidth;
            const h = video.videoHeight;
            screenshotCanvas.width = w;
            screenshotCanvas.height = h;

            try {
                // 1. Dibujar el fotograma del video
                ctx.drawImage(video, 0, 0, w, h);
                
                // 2. Dibujar el canvas de A-Frame (que es transparente) encima
                ctx.drawImage(aframeCanvas, 0, 0, w, h);

                // 3. Obtener la imagen como Data URL
                const imageDataUrl = screenshotCanvas.toDataURL('image/jpeg', 0.9); // 90% de calidad

                // 4. Crear un enlace y simular un clic para descargar
                const link = document.createElement('a');
                const timestamp = new Date().toISOString().replace(/:/g, '-').slice(0, 19);
                link.download = `Captura-AR-${timestamp}.jpg`;
                link.href = imageDataUrl;
                link.click();
                showMessage("Captura guardada!", 2000);

            } catch (error) {
                console.error("Error al crear la captura de pantalla:", error);
                showMessage("Error al tomar la foto. Revisa la consola.", 3000);
            }
        }

        // --- Navigation Event Handlers ---
        function setupNavigationListeners() {
            document.getElementById('goto-map-btn')?.addEventListener('click', () => navigateTo('map'));
            document.getElementById('back-to-admin-btn')?.addEventListener('click', () => navigateTo('admin'));
            document.getElementById('goto-summary-btn')?.addEventListener('click', () => navigateTo('summary'));
            document.getElementById('back-to-map-btn')?.addEventListener('click', () => navigateTo('map'));
            document.getElementById('launch-ar-btn')?.addEventListener('click', () => navigateTo('ar'));
            document.getElementById('back-to-summary-btn')?.addEventListener('click', () => navigateTo('summary')); // AR back button
            
            // (NUEVO) Listener para el botón de captura
            document.getElementById('screenshot-btn')?.addEventListener('click', handleScreenshot);
            
            // Grant permissions button in modal
            document.getElementById('grant-permissions-btn')?.addEventListener('click', () => {
                if (permissionModal) permissionModal.style.display = 'none';
                startARFlow(); // Re-try starting AR after granting permissions
            });
        }

        // --- App Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOM fully loaded and parsed.");

            // Assign DOM element references to variables
            pages = {
                login: document.getElementById('login-page'),
                admin: document.getElementById('admin-page'),
                map: document.getElementById('map-page'),
                summary: document.getElementById('summary-page'),
                ar: document.getElementById('ar-page')
            };
            messageBox = document.getElementById('message-box');
            permissionModal = document.getElementById('permission-modal');
            arLoadingScreen = document.getElementById('ar-loading-screen');
            loadingStatusText = document.getElementById('loading-status-text');
            progressBar = document.getElementById('progress-bar');
            progressBarContainer = document.getElementById('progress-bar-container');
            loadingAssetStatus = document.getElementById('loading-asset-status');
            versionDisplay = document.getElementById('version-display');
            arGuide = document.getElementById('ar-guide');
            guideName = document.getElementById('guide-name');
            guideDistance = document.getElementById('guide-distance');
            guideBearing = document.getElementById('guide-bearing');
            // (NUEVO) Refs para el panel de ubicación en tiempo real
            arRealtimeLocationEl = document.getElementById('ar-realtime-location');
            realtimeLatEl = document.getElementById('realtime-lat');
            realtimeLonEl = document.getElementById('realtime-lon');
            // Fin (NUEVO)
            arScaleSlider = document.getElementById('ar-scale-slider');
            arScaleValueDisplay = document.getElementById('ar-scale-value-display');
            saveArScaleBtn = document.getElementById('save-ar-scale-btn'); // Ref for save scale button
            listContainer = document.getElementById('poi-list-container');
            loadingPois = document.getElementById('loading-pois');
            ecopiensaSelectionList = document.getElementById('ecopiensa-selection-list');
            loadingModelsPlaceholder = document.getElementById('loading-models-placeholder');
            selectVideoCheckbox = document.getElementById('select-video-cb');
            gotoMapButton = document.getElementById('goto-map-btn');
            googleLoginBtn = document.getElementById('google-login-btn');
            logoutBtn = document.getElementById('logout-btn');
            userInfo = document.getElementById('user-info');
            userEmail = document.getElementById('user-email');
            togglePoisBtn = document.getElementById('toggle-pois-btn');
            placementPanel = document.getElementById('placement-panel');
            modelsToPlaceList = document.getElementById('models-to-place-list');
            placementFormContainer = document.getElementById('placement-form-container');
            placingModelName = document.getElementById('placing-model-name');
            cancelPlacementBtn = document.getElementById('cancel-placement-btn');
            savePlacementBtn = document.getElementById('save-placement-btn');
            backToSelectionBtn = document.getElementById('back-to-selection-btn');
            clearSelectionBtn = document.getElementById('clear-selection-btn');
            mapZoomSlider = document.getElementById('map-zoom-slider');
            jumptoBtn = document.getElementById('jumpto-btn');
            placePoiTypeSelect = document.getElementById('place-poi-type');
            modelFieldsDiv = document.getElementById('model-fields');
            videoFieldsDiv = document.getElementById('video-fields');
            placeModelUrlInput = document.getElementById('place-model-url');
            placeVideoUrlInput = document.getElementById('place-video-url');
            placeNameInput = document.getElementById('place-name');
            placeScaleInput = document.getElementById('place-scale'); // Ref for scale input
            placeHeightInput = document.getElementById('place-ground-height'); // Ref for height input
            placeStartDateInput = document.getElementById('place-start-date'); // Ref for start date
            placeEndDateInput = document.getElementById('place-end-date');   // Ref for end date
            placeSoundUrlInput = document.getElementById('place-sound-url'); // Ref for sound url
            placedPoisPanel = document.getElementById('placed-pois-panel');
            placedPoisList = document.getElementById('placed-pois-list');
            editLocationPanel = document.getElementById('edit-location-panel');
            editingPoiNameEl = document.getElementById('editing-poi-name');
            saveEditLocationBtn = document.getElementById('save-edit-location-btn');
            cancelEditLocationBtn = document.getElementById('cancel-edit-location-btn');
            summaryPoiList = document.getElementById('summary-poi-list');
            loadingSummaryPois = document.getElementById('loading-summary-pois');
            mapCenterCoordsEl = document.getElementById('map-center-coords');
            placementPreviewImageEl = document.getElementById('placement-preview-image');
            
            // (NUEVO) Ref para el canvas de captura
            screenshotCanvas = document.getElementById('screenshot-canvas');

            console.log("DOM element references obtained.");

            // Initial setup steps
            loadSelectionFromLocalStorage(); // Load selected models
            displayAppVersion(); // Show app version
            initializeModelSelection(); // Set up checkboxes
            setupNavigationListeners(); // Set up page navigation

            // Attach Auth listeners
            if (googleLoginBtn) googleLoginBtn.addEventListener('click', handleGoogleLogin);
            if (logoutBtn) logoutBtn.addEventListener('click', handleLogout);

            // Attach Map form/button listeners
            if (cancelPlacementBtn) cancelPlacementBtn.addEventListener('click', () => navigateTo('admin')); // Use admin as cancel target
            if (backToSelectionBtn) backToSelectionBtn.addEventListener('click', cancelPlacement);
            if (savePlacementBtn) savePlacementBtn.addEventListener('click', handleSavePlacement);
            if (saveEditLocationBtn) saveEditLocationBtn.addEventListener('click', handleSaveEditLocation);
            if (cancelEditLocationBtn) cancelEditLocationBtn.addEventListener('click', cancelEditLocation);
            if (clearSelectionBtn) clearSelectionBtn.addEventListener('click', clearSavedSelection);

            // Attach AR listeners
            if (arScaleSlider) arScaleSlider.addEventListener('input', applyFineScaleAdjustment); // Adjust scale visually
            if (saveArScaleBtn) saveArScaleBtn.addEventListener('click', handleSaveARScale); // Save scale to Firebase

            // Attach Admin POI list delete listener (uses event delegation)
            if (listContainer) {
                listContainer.addEventListener('click', async (e) => {
                    if (e.target?.classList.contains('delete-btn')) { // Check if a delete button was clicked
                        const docId = e.target.getAttribute('data-id');
                        const button = e.target;
                        if (!docId || button.disabled) return;

                        // Confirmation step
                        if (button.textContent.includes('Eliminar')) {
                            button.textContent = '¿Seguro? Clic otra vez';
                            button.classList.remove('bg-red-500', 'hover:bg-red-600');
                            button.classList.add('bg-yellow-500', 'hover:bg-yellow-600');
                            // Revert after timeout
                            setTimeout(() => {
                                const currentButton = listContainer?.querySelector(`.delete-btn[data-id="${docId}"]`);
                                if (currentButton?.textContent.includes('Clic otra vez')) {
                                    currentButton.textContent = 'Eliminar';
                                    currentButton.classList.remove('bg-yellow-500', 'hover:bg-yellow-600');
                                    currentButton.classList.add('bg-red-500', 'hover:bg-red-600');
                                }
                            }, 3000);
                            return; // Wait for second click
                        }

                        // Confirmed: Proceed with delete
                        if (!firebaseReady || !poiCollectionRef) {
                            showMessage("Error: La base de datos no está lista para eliminar.", 4000);
                            // Reset button state
                            button.textContent = 'Eliminar';
                            button.classList.remove('bg-yellow-500', 'hover:bg-yellow-600');
                            button.classList.add('bg-red-500', 'hover:bg-red-600');
                            return;
                        }
                        try {
                            button.disabled = true;
                            button.textContent = 'Eliminando...';
                            const docRef = doc(db, poiCollectionRef.path, docId);
                            await deleteDoc(docRef);
                            showMessage('Punto de interés eliminado.', 3000);
                            // Snapshot listener will update the UI automatically
                        } catch (error) {
                            console.error("Error deleting document from Admin page: ", error);
                            showMessage("No se pudo eliminar el documento: " + error.message, 5000);
                             // Reset button on error
                             const currentButton = listContainer?.querySelector(`.delete-btn[data-id="${docId}"]`);
                             if (currentButton) {
                                 currentButton.disabled = false;
                                 currentButton.textContent = 'Eliminar';
                                 currentButton.classList.remove('bg-yellow-500', 'hover:bg-yellow-600');
                                 currentButton.classList.add('bg-red-500', 'hover:bg-red-600');
                             }
                        }
                    }
                });
            }
            console.log("Form and List listeners attached.");

            // (CORRECCIÓN) Asegurarse de que esta llamada esté presente
            // Initialize Firebase connection last
            initializeFirebase();
        });
    </script>
</body>
</html>





